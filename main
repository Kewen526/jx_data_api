#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ±Ÿé‘«æ•°æ®æŠ¥è¡¨ç”Ÿæˆç³»ç»Ÿ
æ”¯æŒç”Ÿæˆï¼šæ—¥æŠ¥ã€å‘¨æŠ¥ã€æœˆæŠ¥ã€è‡ªå®šä¹‰æŠ¥è¡¨
å¢åŠ è°ƒè¯•ä¿¡æ¯ï¼šå‡ºé”™æ—¶æ‰“å°å…·ä½“é—¨åº—å’Œå­—æ®µ
"""

import mysql.connector
from mysql.connector import pooling
import openpyxl
from openpyxl.styles import Font, Alignment, Border, Side, PatternFill
from openpyxl.utils import get_column_letter
from datetime import datetime, timedelta
import json
import traceback
import warnings

warnings.filterwarnings('ignore')

# ==================== æ•°æ®åº“è¿æ¥æ± é…ç½® ====================
DB_CONFIG = {
    'host': '8.146.210.145',
    'port': 3306,
    'user': 'root',
    'password': 'Kewen888@',
    'database': 'jx_data_info',  # æ•°æ®åº“åç§°
    'charset': 'utf8mb4',
    'use_unicode': True,
    'autocommit': True
}

# åˆ›å»ºå…¨å±€è¿æ¥æ± ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
CONNECTION_POOL = mysql.connector.pooling.MySQLConnectionPool(
    pool_name="jx_pool",
    pool_size=20,  # è¿æ¥æ± å¤§å°
    pool_reset_session=True,
    **DB_CONFIG
)


# ==================== è°ƒè¯•è¾…åŠ©å‡½æ•° ====================
def debug_print_row(shop_id, shop_name, data_dict, prefix=""):
    """
    æ‰“å°ä¸€è¡Œæ•°æ®çš„è¯¦ç»†ä¿¡æ¯ï¼Œç”¨äºè°ƒè¯•
    """
    print(f"\n{'=' * 60}")
    print(f"ğŸ” è°ƒè¯•ä¿¡æ¯ - {prefix}")
    print(f"é—¨åº—ID: {shop_id}")
    print(f"é—¨åº—åç§°: {shop_name}")
    print(f"{'=' * 60}")

    if data_dict:
        for key, value in data_dict.items():
            value_type = type(value).__name__
            is_none = "âš ï¸ NULL" if value is None else ""
            print(f"  {key}: {value} ({value_type}) {is_none}")
    else:
        print("  æ•°æ®ä¸ºç©ºï¼ˆæ•´è¡Œæ•°æ®ç¼ºå¤±ï¼‰")
    print(f"{'=' * 60}\n")


def safe_get_val(data, key, default=0, shop_id=None, shop_name=None, debug=False):
    """
    å®‰å…¨è·å–å€¼ï¼Œå¤„ç†Noneçš„æƒ…å†µ
    å¦‚æœdebug=Trueï¼Œä¼šæ‰“å°è­¦å‘Šä¿¡æ¯
    """
    if not data:
        if debug:
            print(f"âš ï¸ è­¦å‘Š: é—¨åº— {shop_name}({shop_id}) æ•´è¡Œæ•°æ®ä¸ºç©ºï¼Œå­—æ®µ {key} ä½¿ç”¨é»˜è®¤å€¼ {default}")
        return default

    value = data.get(key)
    if value is None:
        if debug:
            print(f"âš ï¸ è­¦å‘Š: é—¨åº— {shop_name}({shop_id}) å­—æ®µ {key} ä¸ºNULLï¼Œä½¿ç”¨é»˜è®¤å€¼ {default}")
        return default

    return value


# ==================== è¾…åŠ©å‡½æ•° ====================
def get_shop_info_mapping(accounts=None):
    """
    è·å–é—¨åº—ä¿¡æ¯æ˜ å°„
    å‚æ•°:
        accounts: list, å¯é€‰ï¼Œè´¦å·åˆ—è¡¨ï¼ˆplatform_accounts.accountçš„å€¼ï¼‰ï¼Œå¦‚æœæä¾›åˆ™åªæŸ¥è¯¢è¿™äº›è´¦å·
    è¿”å›: dict {shop_id: {'operator': '', 'sales': '', 'city': ''}}
    """
    conn = CONNECTION_POOL.get_connection()
    cursor = conn.cursor(dictionary=True)

    try:
        # 1. æŸ¥è¯¢ platform_accounts å’Œ saas_users
        sql = """
        SELECT
            pa.account,
            pa.stores_json,
            pa.sales_name,
            pa.city_name,
            pa.operator_id,
            su.name as operator_name
        FROM platform_accounts pa
        LEFT JOIN saas_users su ON pa.operator_id = su.id
        WHERE pa.stores_json IS NOT NULL
        """

        # å¦‚æœæŒ‡å®šäº†accountsåˆ—è¡¨ï¼Œæ·»åŠ è¿‡æ»¤æ¡ä»¶
        params = []
        if accounts:
            placeholders = ','.join(['%s'] * len(accounts))
            sql += f" AND pa.account IN ({placeholders})"
            params = accounts

        cursor.execute(sql, params)
        account_results = cursor.fetchall()

        # 2. è§£æ stores_json æ„å»ºæ˜ å°„
        shop_mapping = {}

        for account in account_results:
            stores_json = account.get('stores_json')
            sales_name = account.get('sales_name', '')
            city_name = account.get('city_name', '')
            operator_name = account.get('operator_name', '')

            if stores_json:
                try:
                    # è§£æ JSONï¼ˆå¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–å·²ç»æ˜¯å¯¹è±¡ï¼‰
                    if isinstance(stores_json, str):
                        stores = json.loads(stores_json)
                    else:
                        stores = stores_json

                    # éå†é—¨åº—åˆ—è¡¨
                    if isinstance(stores, list):
                        for store in stores:
                            if isinstance(store, dict):
                                shop_id = str(store.get('shop_id', ''))
                                if shop_id:
                                    shop_mapping[shop_id] = {
                                        'operator': operator_name or '',
                                        'sales': sales_name or '',
                                        'city': city_name or ''
                                    }
                except (json.JSONDecodeError, TypeError):
                    # å¿½ç•¥è§£æé”™è¯¯
                    pass

        return shop_mapping

    finally:
        cursor.close()
        conn.close()


def get_region_info_mapping(accounts=None):
    """
    è·å–å•†åœˆä¿¡æ¯æ˜ å°„
    å‚æ•°:
        accounts: list, å¯é€‰ï¼Œè´¦å·åˆ—è¡¨ï¼ˆplatform_accounts.accountçš„å€¼ï¼‰ï¼Œå¦‚æœæä¾›åˆ™åªæŸ¥è¯¢è¿™äº›è´¦å·
    è¿”å›: dict {shop_id: {'city': '', 'district': '', 'business': ''}}
    æ•°æ®æ¥æº: platform_accounts.compareRegions_json

    compareRegions_json æ•°æ®ç»“æ„ç¤ºä¾‹:
    {
        "1015355375": {
            "cityId": 110100,
            "regions": {
                "city": {"regionId": 110000, "regionName": "åŒ—äº¬å¸‚"},
                "business": {"regionId": 23031, "regionName": "è¥¿ä¸‰æ——"},
                "district": {"regionId": 17, "regionName": "æµ·æ·€åŒº"}
            },
            "shopName": "äº‘å°šÂ·è‰ºå¢ƒç‘œä¼½SPA",
            "branchName": "è¥¿ä¸‰æ——åº—"
        }
    }
    """
    conn = CONNECTION_POOL.get_connection()
    cursor = conn.cursor(dictionary=True)

    try:
        sql = """
        SELECT
            pa.compareRegions_json
        FROM platform_accounts pa
        WHERE pa.compareRegions_json IS NOT NULL
        """

        # å¦‚æœæŒ‡å®šäº†accountsåˆ—è¡¨ï¼Œæ·»åŠ è¿‡æ»¤æ¡ä»¶
        params = []
        if accounts:
            placeholders = ','.join(['%s'] * len(accounts))
            sql += f" AND pa.account IN ({placeholders})"
            params = accounts

        cursor.execute(sql, params)
        account_results = cursor.fetchall()

        region_mapping = {}

        for account in account_results:
            regions_json = account.get('compareRegions_json')

            if regions_json:
                try:
                    # è§£æå•†åœˆæ•°æ®
                    if isinstance(regions_json, str):
                        regions = json.loads(regions_json)
                    else:
                        regions = regions_json

                    # compareRegions_json æ ¼å¼: {shop_id: {regions: {city: {}, district: {}, business: {}}}}
                    if isinstance(regions, dict):
                        for shop_id, shop_data in regions.items():
                            if isinstance(shop_data, dict):
                                regions_data = shop_data.get('regions', {})
                                if isinstance(regions_data, dict):
                                    city_info = regions_data.get('city', {})
                                    district_info = regions_data.get('district', {})
                                    business_info = regions_data.get('business', {})

                                    region_mapping[str(shop_id)] = {
                                        'city': city_info.get('regionName', '') if isinstance(city_info, dict) else '',
                                        'district': district_info.get('regionName', '') if isinstance(district_info,
                                                                                                      dict) else '',
                                        'business': business_info.get('regionName', '') if isinstance(business_info,
                                                                                                      dict) else ''
                                    }
                except (json.JSONDecodeError, TypeError):
                    pass

        return region_mapping

    finally:
        cursor.close()
        conn.close()


def get_coupon_orders_last_7days(shop_id, report_date):
    """
    è·å–è¿‘7å¤©ä¼˜æƒ ç è®¢å•æ€»æ•°
    å‚æ•°:
        shop_id: é—¨åº—ID
        report_date: æŠ¥è¡¨æ—¥æœŸ (str 'YYYY-MM-DD')
    è¿”å›: int è¿‘7å¤©ä¼˜æƒ ç è®¢å•æ€»æ•°
    æ•°æ®æ¥æº: kewen_daily_report.coupon_pay_order_count
    """
    conn = CONNECTION_POOL.get_connection()
    cursor = conn.cursor(dictionary=True)

    try:
        # è®¡ç®—7å¤©å‰çš„æ—¥æœŸ
        end_date = datetime.strptime(report_date, '%Y-%m-%d')
        start_date = end_date - timedelta(days=6)

        sql = """
        SELECT COALESCE(SUM(coupon_pay_order_count), 0) as total
        FROM kewen_daily_report
        WHERE shop_id = %s
          AND report_date BETWEEN %s AND %s
        """

        cursor.execute(sql, (shop_id, start_date.strftime('%Y-%m-%d'), report_date))
        result = cursor.fetchone()

        return int(result['total']) if result and result['total'] else 0

    finally:
        cursor.close()
        conn.close()


def get_ad_orders_last_7days(shop_id, report_date):
    """
    è·å–è¿‘7å¤©å¹¿å‘Šå•æ€»æ•°
    å‚æ•°:
        shop_id: é—¨åº—ID
        report_date: æŠ¥è¡¨æ—¥æœŸ (str 'YYYY-MM-DD')
    è¿”å›: int è¿‘7å¤©å¹¿å‘Šå•æ€»æ•°
    æ•°æ®æ¥æº: store_stats.ad_order_count
    """
    conn = CONNECTION_POOL.get_connection()
    cursor = conn.cursor(dictionary=True)

    try:
        # è®¡ç®—7å¤©å‰çš„æ—¥æœŸ
        end_date = datetime.strptime(report_date, '%Y-%m-%d')
        start_date = end_date - timedelta(days=6)

        sql = """
        SELECT COALESCE(SUM(ad_order_count), 0) as total
        FROM store_stats
        WHERE store_id = %s
          AND date BETWEEN %s AND %s
        """

        cursor.execute(sql, (shop_id, start_date.strftime('%Y-%m-%d'), report_date))
        result = cursor.fetchone()

        return int(result['total']) if result and result['total'] else 0

    finally:
        cursor.close()
        conn.close()


def get_ad_orders_today(shop_id, report_date):
    """
    è·å–å½“å¤©å¹¿å‘Šå•æ•°é‡
    å‚æ•°:
        shop_id: é—¨åº—ID
        report_date: æŠ¥è¡¨æ—¥æœŸ (str 'YYYY-MM-DD')
    è¿”å›: int å½“å¤©å¹¿å‘Šå•æ•°é‡
    æ•°æ®æ¥æº: store_stats.ad_order_count
    """
    conn = CONNECTION_POOL.get_connection()
    cursor = conn.cursor(dictionary=True)

    try:
        sql = """
        SELECT COALESCE(ad_order_count, 0) as total
        FROM store_stats
        WHERE store_id = %s
          AND date = %s
        """

        cursor.execute(sql, (shop_id, report_date))
        result = cursor.fetchone()

        return int(result['total']) if result and result['total'] else 0

    finally:
        cursor.close()
        conn.close()


def clean_sheet_name(name, max_length=31):
    """
    æ¸…ç† Sheet åç§°ï¼Œç¬¦åˆ Excel è§„èŒƒ
    - æœ€å¤§ 31 å­—ç¬¦
    - ä¸èƒ½åŒ…å«: \ / * ? : [ ]
    """
    if not name:
        return "Sheet"

    # æ›¿æ¢éæ³•å­—ç¬¦
    illegal_chars = ['\\', '/', '*', '?', ':', '[', ']']
    for char in illegal_chars:
        name = name.replace(char, '')

    # æˆªæ–­åˆ°æœ€å¤§é•¿åº¦
    if len(name) > max_length:
        name = name[:max_length]

    return name or "Sheet"


def apply_border(ws, min_row, max_row, min_col, max_col):
    """åº”ç”¨è¾¹æ¡†æ ·å¼"""
    thin_border = Border(
        left=Side(style='thin'),
        right=Side(style='thin'),
        top=Side(style='thin'),
        bottom=Side(style='thin')
    )
    for row in ws.iter_rows(min_row=min_row, max_row=max_row, min_col=min_col, max_col=max_col):
        for cell in row:
            cell.border = thin_border


# ==================== æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆæ—¥æŠ¥ ====================
def generate_daily_report(report_date, accounts=None, output_filename=None):
    """
    ç”Ÿæˆæ—¥æŠ¥
    - Sheet 1: "æ±‡æ€»" - æ¨ªå‘è¡¨æ ¼ï¼Œæ¯è¡Œä¸€ä¸ªé—¨åº—
    - Sheet 2-N: é—¨åº—è¯¦ç»† - ç«–å‘è¡¨æ ¼

    å‚æ•°:
        report_date: str, æŠ¥è¡¨æ—¥æœŸï¼Œæ ¼å¼: 'YYYY-MM-DD'
        accounts: list, å¯é€‰ï¼Œé—¨åº—è´¦å·åˆ—è¡¨ï¼ˆplatform_accounts.accountçš„å€¼ï¼‰ï¼Œå¦‚["13718175572a","19318574226a"]ï¼Œå¦‚æœæä¾›åˆ™åªç”Ÿæˆè¿™äº›è´¦å·çš„æ—¥æŠ¥
        output_filename: str, è¾“å‡ºæ–‡ä»¶åï¼Œé»˜è®¤è‡ªåŠ¨ç”Ÿæˆ

    è¿”å›:
        str: ç”Ÿæˆçš„æ–‡ä»¶è·¯å¾„
    """
    # 1. å¦‚æœæŒ‡å®šäº†accountsï¼Œå…ˆè·å–å¯¹åº”çš„shop_idåˆ—è¡¨
    shop_ids_filter = None
    if accounts:
        print(f"æ­£åœ¨æŸ¥è¯¢æŒ‡å®šè´¦å·çš„é—¨åº—ä¿¡æ¯: {accounts}")
        conn_temp = CONNECTION_POOL.get_connection()
        cursor_temp = conn_temp.cursor(dictionary=True)
        try:
            placeholders = ','.join(['%s'] * len(accounts))
            sql_accounts = f"""
            SELECT stores_json, compareRegions_json
            FROM platform_accounts
            WHERE account IN ({placeholders})
            """
            cursor_temp.execute(sql_accounts, accounts)
            account_data = cursor_temp.fetchall()

            # ä»stores_jsonä¸­æå–shop_id
            shop_ids_filter = []
            for acc in account_data:
                stores_json = acc.get('stores_json')
                if stores_json:
                    try:
                        if isinstance(stores_json, str):
                            stores = json.loads(stores_json)
                        else:
                            stores = stores_json

                        if isinstance(stores, list):
                            for store in stores:
                                if isinstance(store, dict):
                                    shop_id = str(store.get('shop_id', ''))
                                    if shop_id:
                                        shop_ids_filter.append(shop_id)
                    except (json.JSONDecodeError, TypeError):
                        pass

            print(f"æ‰¾åˆ° {len(shop_ids_filter)} ä¸ªé—¨åº—")
        finally:
            cursor_temp.close()
            conn_temp.close()

    # 2. è·å–é—¨åº—ä¿¡æ¯æ˜ å°„
    print("æ­£åœ¨åŠ è½½é—¨åº—ä¿¡æ¯...")
    shop_mapping = get_shop_info_mapping(accounts)
    region_mapping = get_region_info_mapping(accounts)

    # 3. ä»è¿æ¥æ± è·å–è¿æ¥
    conn = CONNECTION_POOL.get_connection()
    cursor = conn.cursor(dictionary=True)

    try:
        # SQL æŸ¥è¯¢ï¼šå…³è” kewen_daily_report + promotion_daily_report + store_stats
        sql = """
        SELECT
            k.report_date,
            k.shop_id,
            k.shop_name,
            k.exposure_users,
            k.visit_users,
            k.order_users,
            k.verify_person_count as verify_users,
            k.order_coupon_count,
            k.verify_coupon_count,
            k.promotion_cost,
            k.new_good_review_count,
            k.new_review_count,
            k.new_collect_users,
            k.consult_users,
            k.intent_rate,
            k.order_sale_amount,
            k.verify_sale_amount,
            k.verify_after_discount,
            p.view_phone_count as phone_clicks,
            p.view_address_count as address_clicks,
            p.click_avg_price,
            p.order_count as promotion_order_count,
            s.order_user_rank,
            s.verify_amount_rank,
            s.checkin_count,
            s.ad_balance,
            s.ad_order_count,
            s.is_force_offline
        FROM kewen_daily_report k
        LEFT JOIN promotion_daily_report p
            ON k.shop_id = p.shop_id AND k.report_date = p.report_date
        LEFT JOIN store_stats s
            ON k.shop_id = s.store_id AND k.report_date = s.date
        WHERE k.report_date = %s
        """

        # æ·»åŠ shop_idè¿‡æ»¤æ¡ä»¶
        params = [report_date]
        if shop_ids_filter:
            placeholders = ','.join(['%s'] * len(shop_ids_filter))
            sql += f" AND k.shop_id IN ({placeholders})"
            params.extend(shop_ids_filter)

        sql += " ORDER BY k.shop_id"

        cursor.execute(sql, params)
        rows = cursor.fetchall()

        if not rows:
            print(f"è­¦å‘Šï¼š{report_date} æ²¡æœ‰æ•°æ®")
            return None

        # 3. åˆ›å»º Excel å·¥ä½œç°¿
        wb = openpyxl.Workbook()

        # ==================== Sheet 1: æ±‡æ€» ====================
        ws_summary = wb.active
        ws_summary.title = "æ±‡æ€»"

        # æ ¼å¼åŒ–æ—¥æœŸ
        date_obj = datetime.strptime(report_date, '%Y-%m-%d')
        weekday_names = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥']
        weekday = weekday_names[date_obj.weekday()]
        date_str = date_obj.strftime('%mæœˆ%dæ—¥')
        date_short = date_obj.strftime('%m/%d')

        # æ±‡æ€»è¡¨å¤´
        summary_headers = [
            'æ˜ŸæœŸ', 'æ—¥æœŸ', 'åºå·', 'è¿è¥', 'åŸå¸‚', 'é”€å”®', 'é—¨åº—',
            'æ›å…‰äººæ•°', 'è®¿é—®äººæ•°', 'ä¸‹å•äººæ•°', 'æ ¸é”€äººæ•°', 'ä¸‹å•åˆ¸æ•°', 'æ ¸é”€åˆ¸æ•°',
            'ç”µè¯ç‚¹å‡»', 'åœ°å€ç‚¹å‡»', 'æ¨å¹¿é€šæ¶ˆè€—', 'å¥½è¯„', 'æ„å‘è½¬åŒ–ç‡',
            'ä¸‹å•å”®ä»·é‡‘é¢', 'æ ¸é”€å”®ä»·é‡‘é¢', 'ä¼˜æƒ åæ ¸é”€é‡‘é¢',
            'ä¸‹å•äººæ•°å•†åœˆæ’å', 'æ ¸é”€é‡‘é¢å•†åœˆæ’å'
        ]
        ws_summary.append(summary_headers)

        # æ±‡æ€»è¡¨å¤´æ ·å¼
        header_fill = PatternFill(start_color="D3D3D3", end_color="D3D3D3", fill_type="solid")
        header_font = Font(bold=True, size=10)
        for cell in ws_summary[1]:
            cell.fill = header_fill
            cell.font = header_font
            cell.alignment = Alignment(horizontal='center', vertical='center')

        # ç”¨äºå¤„ç†é‡å Sheet
        sheet_names_used = {}

        # 4. ä¸ºæ¯ä¸ªé—¨åº—å†™å…¥æ±‡æ€»è¡Œ + åˆ›å»ºè¯¦ç»†Sheet
        for idx, row in enumerate(rows, start=1):
            shop_id = str(row['shop_id'])
            shop_name = row['shop_name'] or f'é—¨åº—{shop_id}'

            # ä»æ˜ å°„ä¸­è·å–è¿è¥ã€åŸå¸‚ã€é”€å”®
            shop_info = shop_mapping.get(shop_id, {})
            operator = shop_info.get('operator', '')
            sales = shop_info.get('sales', '')
            city = shop_info.get('city', '')

            # è·å–å•†åœˆä¿¡æ¯
            region_info = region_mapping.get(shop_id, {})
            region_city = region_info.get('city', city)
            region_district = region_info.get('district', '')
            region_business = region_info.get('business', '')

            # æ ¼å¼åŒ–å•†åœˆæ’å
            order_rank = row['order_user_rank']
            verify_rank = row['verify_amount_rank']
            order_rank_str = f"ç¬¬{order_rank}å" if order_rank and order_rank < 100 else (
                "å¤§äº100å" if order_rank and order_rank >= 100 else "--")
            verify_rank_str = f"ç¬¬{verify_rank}å" if verify_rank and verify_rank < 100 else (
                "å¤§äº100å" if verify_rank and verify_rank >= 100 else "--")

            # å†™å…¥æ±‡æ€»æ•°æ®è¡Œ
            summary_row = [
                weekday,
                date_str,
                idx,
                operator,
                city,
                sales,
                shop_name,
                row['exposure_users'] or 0,
                row['visit_users'] or 0,
                row['order_users'] or 0,
                row['verify_users'] or 0,
                row['order_coupon_count'] or 0,
                row['verify_coupon_count'] or 0,
                row['phone_clicks'] or 0,
                row['address_clicks'] or 0,
                round(row['promotion_cost'], 2) if row['promotion_cost'] else 0,
                row['new_good_review_count'] or 0,
                row['intent_rate'] or '0%',
                round(row['order_sale_amount'], 2) if row['order_sale_amount'] else 0,
                round(row['verify_sale_amount'], 2) if row['verify_sale_amount'] else 0,
                round(row['verify_after_discount'], 2) if row['verify_after_discount'] else 0,
                order_rank_str,
                verify_rank_str
            ]
            ws_summary.append(summary_row)

            # ==================== Sheet 2-N: é—¨åº—è¯¦ç»†ï¼ˆç«–å‘è¡¨æ ¼ï¼‰====================
            # æ¸…ç† Sheet åç§°
            sheet_name = clean_sheet_name(shop_name)

            # å¤„ç†é‡åï¼ˆæ·»åŠ åºå·ï¼‰
            if sheet_name in sheet_names_used:
                sheet_names_used[sheet_name] += 1
                sheet_name = f"{sheet_name[:28]}_{sheet_names_used[sheet_name]}"
            else:
                sheet_names_used[sheet_name] = 1

            # åˆ›å»ºè¯¦ç»† Sheet
            ws_detail = wb.create_sheet(title=sheet_name)

            # è®¡ç®—è¾¾æ ‡çŠ¶æ€
            order_users = row['order_users'] or 0
            verify_users = row['verify_users'] or 0
            new_review_count = row['new_review_count'] or 0
            new_collect_users = row['new_collect_users'] or 0

            # ç•™è¯„ç‡ = æ–°å¢è¯„ä»· / æ ¸é”€äººæ•°
            review_rate = (new_review_count / verify_users * 100) if verify_users > 0 else 0
            review_rate_str = f"{review_rate:.1f}%"
            review_qualified = "è¾¾æ ‡" if review_rate >= 30 else "æœªè¾¾æ ‡"

            # æ”¶è—ç‡ = æ–°å¢æ”¶è— / ä¸‹å•äººæ•°
            collect_rate = (new_collect_users / order_users * 100) if order_users > 0 else 0
            collect_rate_str = f"{collect_rate:.1f}%"
            collect_qualified = "è¾¾æ ‡" if collect_rate >= 40 else "æœªè¾¾æ ‡"

            # è¿‘7å¤©ä¼˜æƒ ç è®¢å•ï¼ˆ7å¤©>=10å•è¾¾æ ‡ï¼‰
            coupon_7days = get_coupon_orders_last_7days(shop_id, report_date)
            coupon_qualified = "è¾¾æ ‡" if coupon_7days >= 10 else "æœªè¾¾æ ‡"

            # å½“å¤©å¹¿å‘Šå•ï¼ˆå½“å¤©>=1å•è¾¾æ ‡ï¼‰
            ad_today = get_ad_orders_today(shop_id, report_date)
            ad_qualified = "è¾¾æ ‡" if ad_today >= 1 else "æœªè¾¾æ ‡"

            # å¼ºåˆ¶ä¸‹çº¿çŠ¶æ€ä¿¡æ¯
            is_force_offline = row['is_force_offline'] or 0
            if is_force_offline > 0:
                status_info = f"âš ï¸ è­¦å‘Šï¼šæœ‰{is_force_offline}ä¸ªå›¢å•è¢«å¼ºåˆ¶ä¸‹çº¿ï¼"
            else:
                status_info = "ä»Šå¤©é‚®ä»¶å·²æŸ¥çœ‹ï¼Œæ— è¿è§„æ— å¼‚å¸¸ã€‚"

            # å•†åœˆæ’åæ˜¾ç¤ºï¼ˆæ ¼å¼ï¼šåŸå¸‚ | åŒº | å•†åœˆï¼šç¬¬Xåï¼‰
            region_display = f"{region_city} | {region_district} | {region_business}" if region_business else city
            order_rank_display = f"{region_display}ï¼šç¬¬{order_rank}å" if order_rank and order_rank < 100 else f"{region_display}ï¼šå¤§äº100å"
            verify_rank_display = f"{region_display}ï¼šç¬¬{verify_rank}å" if verify_rank and verify_rank < 100 else f"{region_display}ï¼šå¤§äº100å"

            # æ„å»ºç«–å‘è¡¨æ ¼æ•°æ®
            detail_data = [
                [shop_name, status_info, ''],
                [f"æ•°æ®æŠ¥è¡¨", f"æ—¥æœŸ({date_short})", ''],
                ['ã€ç¾å›¢ç‚¹è¯„å¹¿å‘Šç»“æœæ•°æ®ã€‘', '', ''],
                ['æ›å…‰äººæ•°ï¼š', row['exposure_users'] or 0, ''],
                ['è®¿é—®äººæ•°ï¼š', row['visit_users'] or 0, ''],
                ['ä¸‹å•äººæ•°ï¼š', row['order_users'] or 0, ''],
                ['ä¸‹å•åˆ¸æ•°ï¼š', row['order_coupon_count'] or 0, ''],
                ['æ ¸é”€äººæ•°ï¼š', row['verify_users'] or 0, ''],
                ['æ ¸é”€åˆ¸æ•°ï¼š', row['verify_coupon_count'] or 0, ''],
                ['ç”µè¯ç‚¹å‡»ï¼š', row['phone_clicks'] or 0, ''],
                ['åœ°å€ç‚¹å‡»ï¼š', row['address_clicks'] or 0, ''],
                ['åœ¨çº¿å’¨è¯¢ï¼š', row['consult_users'] or 0, ''],
                ['', '', ''],
                ['ã€åº—å†…å¹²é¢„æ•°æ®ã€‘', '', ''],
                ['æ–°å¢æ”¶è—ï¼š', row['new_collect_users'] or 0, ''],
                ['æ–°å¢æ‰“å¡ï¼š', row['checkin_count'] or 0, ''],
                ['æ–°å¢è¯„ä»·ï¼š', row['new_review_count'] or 0, ''],
                ['', '', ''],
                ['ã€æ¨å¹¿é€šæ•°æ®ã€‘', '', ''],
                ['æ¨å¹¿é€šæ¶ˆè€—ï¼š', round(row['promotion_cost'], 2) if row['promotion_cost'] else 0, ''],
                ['æ¨å¹¿é€šç‚¹å‡»å•ä»·ï¼š', round(row['click_avg_price'], 2) if row['click_avg_price'] else 0, ''],
                ['æ¨å¹¿é€šä¸‹å•é‡ï¼š', row['promotion_order_count'] or 0, ''],
                ['æ¨å¹¿é€šä½™é¢ï¼š', round(row['ad_balance'], 2) if row['ad_balance'] else 0, ''],
                ['', '', ''],
                [f'ç•™è¯„ç‡ï¼ˆ30%è¾¾æ ‡ï¼‰ï¼š', review_rate_str, review_qualified],
                [f'æ”¶è—ç‡ï¼ˆ40%è¾¾æ ‡ï¼‰ï¼š', collect_rate_str, collect_qualified],
                [f'è¿‘7å¤©ä¼˜æƒ ç è®¢å•æ˜¯å¦è¾¾æ ‡ï¼š', coupon_7days, coupon_qualified],
                [f'å¹¿å‘Šå•ï¼š', f"å½“å¤©{ad_today}å•", ad_qualified],
                ['', '', ''],
                ['ä¸‹å•å”®ä»·é‡‘é¢ï¼š', round(row['order_sale_amount'], 2) if row['order_sale_amount'] else 0, ''],
                ['æ ¸é”€å”®ä»·é‡‘é¢ï¼š', round(row['verify_sale_amount'], 2) if row['verify_sale_amount'] else 0, ''],
                ['ä¸‹å•äººæ•°å•†åœˆæ’åï¼š', order_rank_display, ''],
                ['æ ¸é”€é‡‘é¢å•†åœˆæ’åï¼š', verify_rank_display, ''],
                ['', '', ''],
                ['å›¢å•è¢«å¼ºåˆ¶ä¸‹çº¿æ•°é‡ï¼š', is_force_offline, ''],
                ['', '', ''],
                ['è¿è¥ï¼š', operator, ''],
                ['é”€å”®ï¼š', sales, ''],
                ['åŸå¸‚ï¼š', city, ''],
            ]

            # å†™å…¥è¯¦ç»†æ•°æ®
            for row_data in detail_data:
                ws_detail.append(row_data)

            # è®¾ç½®è¯¦ç»†Sheetæ ·å¼ï¼ˆAåˆ—å®½æ”¹ä¸º40ï¼‰
            ws_detail.column_dimensions['A'].width = 40
            ws_detail.column_dimensions['B'].width = 30
            ws_detail.column_dimensions['C'].width = 15

            # æ‰€æœ‰å•å…ƒæ ¼å±…ä¸­å¯¹é½
            for row_num in range(1, len(detail_data) + 1):
                for col_num in range(1, 4):
                    ws_detail.cell(row=row_num, column=col_num).alignment = Alignment(horizontal='center', vertical='center')

            # æ ‡é¢˜è¡Œæ ·å¼
            ws_detail['A1'].font = Font(bold=True, size=12)
            ws_detail['B1'].font = Font(bold=True, size=10, color="FF0000" if is_force_offline > 0 else "008000")

            # åˆ†ç±»æ ‡é¢˜æ ·å¼
            section_rows = [3, 14, 19]  # ã€ç¾å›¢ç‚¹è¯„å¹¿å‘Šç»“æœæ•°æ®ã€‘ç­‰è¡Œ
            for r in section_rows:
                ws_detail.cell(row=r, column=1).font = Font(bold=True, size=10, color="0066CC")

            # è¾¾æ ‡/æœªè¾¾æ ‡æ ·å¼
            qualified_rows = [25, 26, 27, 28]
            for r in qualified_rows:
                cell = ws_detail.cell(row=r, column=3)
                if cell.value == "æœªè¾¾æ ‡":
                    cell.font = Font(bold=True, color="FF0000")
                elif cell.value == "è¾¾æ ‡":
                    cell.font = Font(bold=True, color="008000")

            # åº”ç”¨è¾¹æ¡†
            apply_border(ws_detail, 1, len(detail_data), 1, 3)

        # è®¾ç½®æ±‡æ€»è¡¨åˆ—å®½ï¼ˆGåˆ—é—¨åº—æ”¹ä¸º46ï¼‰
        summary_widths = [6, 8, 5, 12, 8, 8, 46, 10, 10, 10, 10, 10, 10, 10, 10, 12, 8, 12, 12, 12, 12, 14, 14]
        for col_idx, width in enumerate(summary_widths, start=1):
            ws_summary.column_dimensions[get_column_letter(col_idx)].width = width

        # æ±‡æ€»è¡¨æ‰€æœ‰æ•°æ®å±…ä¸­å¯¹é½
        for row in ws_summary.iter_rows(min_row=1, max_row=len(rows) + 1, min_col=1, max_col=len(summary_headers)):
            for cell in row:
                cell.alignment = Alignment(horizontal='center', vertical='center')

        # åº”ç”¨æ±‡æ€»è¡¨è¾¹æ¡†
        apply_border(ws_summary, 1, len(rows) + 1, 1, len(summary_headers))

        # 5. ä¿å­˜æ–‡ä»¶
        if not output_filename:
            output_filename = f"æ—¥æŠ¥ éé¤ {report_date.replace('-', '')} {datetime.now().strftime('%Y%m%d%H%M%S')}.xlsx"

        wb.save(output_filename)
        print(f"âœ… æ—¥æŠ¥ç”ŸæˆæˆåŠŸ: {output_filename}ï¼ˆå…± {len(rows)} ä¸ªé—¨åº—ï¼‰")
        return output_filename

    finally:
        cursor.close()
        conn.close()


# ==================== æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆå‘¨æŠ¥ ====================
def generate_weekly_report(week1_start, week1_end, week2_start, week2_end, output_filename=None):
    """
    ç”Ÿæˆå‘¨æŠ¥ï¼ˆä¸¤å‘¨å¯¹æ¯”ï¼‰
    - Sheet 1: "æ±‡æ€»" - æ¯é—¨åº—8è¡Œçš„æ¨ªå‘ç»“æ„
    - Sheet 2-N: é—¨åº—è¯¦ç»† - ç«–å‘31è¡Œç»“æ„

    å‚æ•°:
        week1_start: str, ç¬¬ä¸€å‘¨å¼€å§‹æ—¥æœŸ 'YYYY-MM-DD'
        week1_end: str, ç¬¬ä¸€å‘¨ç»“æŸæ—¥æœŸ 'YYYY-MM-DD'
        week2_start: str, ç¬¬äºŒå‘¨å¼€å§‹æ—¥æœŸ 'YYYY-MM-DD'
        week2_end: str, ç¬¬äºŒå‘¨ç»“æŸæ—¥æœŸ 'YYYY-MM-DD'
        output_filename: str, è¾“å‡ºæ–‡ä»¶å
    """
    # è·å–é—¨åº—ä¿¡æ¯æ˜ å°„
    shop_mapping = get_shop_info_mapping()

    conn = CONNECTION_POOL.get_connection()
    cursor = conn.cursor(dictionary=True)

    try:
        # æŸ¥è¯¢å‘¨æ•°æ®ï¼ˆåŒ…å« store_statsï¼‰
        sql_week = """
        SELECT
            k.shop_id,
            k.shop_name,
            SUM(k.verify_after_discount) as verify_after_discount,
            SUM(k.exposure_users) as exposure_users,
            SUM(k.visit_users) as visit_users,
            SUM(k.order_users) as order_users,
            SUM(k.order_coupon_count) as order_coupon_count,
            SUM(k.verify_person_count) as verify_users,
            SUM(k.verify_coupon_count) as verify_coupon_count,
            SUM(k.order_sale_amount) as order_sale_amount,
            SUM(k.verify_sale_amount) as verify_sale_amount,
            SUM(k.coupon_pay_order_count) as coupon_orders,
            SUM(p.view_phone_count) as phone_clicks,
            SUM(k.promotion_cost) as promotion_cost,
            SUM(k.promotion_exposure_count) as promotion_exposure,
            SUM(k.promotion_click_count) as promotion_clicks,
            SUM(p.order_count) as promotion_orders,
            SUM(p.view_groupbuy_count) as view_groupbuy,
            SUM(p.view_phone_count) as view_phone,
            SUM(k.consult_users) as consult_users,
            SUM(p.view_address_count) as address_clicks,
            SUM(k.new_collect_users) as new_collect,
            SUM(k.new_good_review_count) as new_good_reviews,
            SUM(k.new_review_count) as new_reviews,
            SUM(s.checkin_count) as checkin_count
        FROM kewen_daily_report k
        LEFT JOIN promotion_daily_report p
            ON k.shop_id = p.shop_id AND k.report_date = p.report_date
        LEFT JOIN store_stats s
            ON k.shop_id = s.store_id AND k.report_date = s.date
        WHERE k.report_date BETWEEN %s AND %s
        GROUP BY k.shop_id, k.shop_name
        ORDER BY k.shop_id
        """

        # è·å–ç¬¬ä¸€å‘¨æ•°æ®
        cursor.execute(sql_week, (week1_start, week1_end))
        week1_data = {row['shop_id']: row for row in cursor.fetchall()}

        # è·å–ç¬¬äºŒå‘¨æ•°æ®
        cursor.execute(sql_week, (week2_start, week2_end))
        week2_data = {row['shop_id']: row for row in cursor.fetchall()}

        # è·å–æ‰€æœ‰é—¨åº—åˆ—è¡¨
        all_shop_ids = set(week1_data.keys()) | set(week2_data.keys())

        if not all_shop_ids:
            print("è­¦å‘Šï¼šæ²¡æœ‰æ‰¾åˆ°æ•°æ®")
            return None

        print(f"ğŸ“Š æ‰¾åˆ° {len(all_shop_ids)} ä¸ªé—¨åº—æ•°æ®")

        # åˆ›å»º Excel
        wb = openpyxl.Workbook()
        ws_summary = wb.active
        ws_summary.title = "æ±‡æ€»"

        # æ ¼å¼åŒ–æ—¥æœŸå‘¨æœŸ
        week1_period = f"{datetime.strptime(week1_start, '%Y-%m-%d').strftime('%Y.%m.%d')}-{datetime.strptime(week1_end, '%Y-%m-%d').strftime('%Y.%m.%d')}"
        week2_period = f"{datetime.strptime(week2_start, '%Y-%m-%d').strftime('%Y.%m.%d')}-{datetime.strptime(week2_end, '%Y-%m-%d').strftime('%Y.%m.%d')}"

        # è¾…åŠ©å‡½æ•° - ä¿®æ”¹ä¸ºå®‰å…¨ç‰ˆæœ¬
        def get_val(data, key, default=0):
            """å®‰å…¨è·å–å€¼ï¼Œå¤„ç†None"""
            if not data:
                return default
            value = data.get(key)
            if value is None:
                return default
            return value

        def calc_rate(numerator, denominator):
            if denominator and denominator > 0:
                return round(numerator / denominator * 100, 1)
            return 0

        def calc_avg_price(total, count):
            if count and count > 0:
                return round(total / count, 2)
            return 0

        # ç”¨äºå¤„ç†é‡å Sheet
        sheet_names_used = {}

        # è®°å½•æœ‰é—®é¢˜çš„é—¨åº—
        error_shops = []

        # åºå·è®¡æ•°å™¨
        shop_seq = 0

        # ä¸ºæ¯ä¸ªé—¨åº—ç”Ÿæˆæ•°æ®
        for shop_id in sorted(all_shop_ids):
            w1 = week1_data.get(shop_id, {})
            w2 = week2_data.get(shop_id, {})
            shop_name = w2.get('shop_name') or w1.get('shop_name', 'æœªçŸ¥é—¨åº—')

            # è·å–é—¨åº—ä¿¡æ¯
            shop_id_str = str(shop_id)
            shop_info = shop_mapping.get(shop_id_str, {})
            operator = shop_info.get('operator', '--')
            sales = shop_info.get('sales', '--') or '--'
            city = shop_info.get('city', '--') or '--'

            # åºå·é€’å¢
            shop_seq += 1

            try:
                # ==================== æ±‡æ€»Sheet: 8è¡Œ/é—¨åº— ====================
                # ç¬¬ä¸€å‘¨æŒ‡æ ‡
                w1_verify_discount = get_val(w1, 'verify_after_discount')
                w1_exposure = get_val(w1, 'exposure_users')
                w1_visit = get_val(w1, 'visit_users')
                w1_order_users = get_val(w1, 'order_users')
                w1_order_coupons = get_val(w1, 'order_coupon_count')
                w1_verify_users = get_val(w1, 'verify_users')
                w1_verify_coupons = get_val(w1, 'verify_coupon_count')
                w1_order_amount = get_val(w1, 'order_sale_amount')
                w1_verify_amount = get_val(w1, 'verify_sale_amount')
                w1_coupon_orders = get_val(w1, 'coupon_orders')
                w1_phone_clicks = get_val(w1, 'phone_clicks')

                w1_exposure_rate = f"{calc_rate(w1_visit, w1_exposure)}%"
                w1_order_rate = f"{calc_rate(w1_order_users, w1_visit)}%"
                w1_avg_price = calc_avg_price(w1_verify_discount, w1_verify_users)

                # ç¬¬äºŒå‘¨æŒ‡æ ‡
                w2_verify_discount = get_val(w2, 'verify_after_discount')
                w2_exposure = get_val(w2, 'exposure_users')
                w2_visit = get_val(w2, 'visit_users')
                w2_order_users = get_val(w2, 'order_users')
                w2_order_coupons = get_val(w2, 'order_coupon_count')
                w2_verify_users = get_val(w2, 'verify_users')
                w2_verify_coupons = get_val(w2, 'verify_coupon_count')
                w2_order_amount = get_val(w2, 'order_sale_amount')
                w2_verify_amount = get_val(w2, 'verify_sale_amount')
                w2_coupon_orders = get_val(w2, 'coupon_orders')
                w2_phone_clicks = get_val(w2, 'phone_clicks')

                w2_exposure_rate = f"{calc_rate(w2_visit, w2_exposure)}%"
                w2_order_rate = f"{calc_rate(w2_order_users, w2_visit)}%"
                w2_avg_price = calc_avg_price(w2_verify_discount, w2_verify_users)

                # è®¡ç®—å·®å€¼
                diff_verify_discount = round(w2_verify_discount - w1_verify_discount, 2)
                diff_exposure = w2_exposure - w1_exposure
                diff_visit = w2_visit - w1_visit
                diff_order_users = w2_order_users - w1_order_users
                diff_order_coupons = w2_order_coupons - w1_order_coupons
                diff_verify_users = w2_verify_users - w1_verify_users
                diff_verify_coupons = w2_verify_coupons - w1_verify_coupons
                diff_order_amount = round(w2_order_amount - w1_order_amount, 2)
                diff_verify_amount = round(w2_verify_amount - w1_verify_amount, 2)
                diff_coupon_orders = w2_coupon_orders - w1_coupon_orders
                diff_phone_clicks = w2_phone_clicks - w1_phone_clicks
                diff_avg_price = round(w2_avg_price - w1_avg_price, 2)

                # å·®å€¼ç™¾åˆ†æ¯”
                def calc_rate_diff(rate1_str, rate2_str):
                    val1 = float(rate1_str.rstrip('%')) if rate1_str != '0%' else 0
                    val2 = float(rate2_str.rstrip('%')) if rate2_str != '0%' else 0
                    return f"{round(val2 - val1, 1)}%"

                diff_exposure_rate = calc_rate_diff(w1_exposure_rate, w2_exposure_rate)
                diff_order_rate = calc_rate_diff(w1_order_rate, w2_order_rate)

                # æ¨å¹¿é€šç›¸å…³æ•°æ®ï¼ˆæå‰è®¡ç®—ï¼Œç”¨äºåé¢ï¼‰
                w1_promo_cost = get_val(w1, 'promotion_cost')
                w1_promo_exposure = get_val(w1, 'promotion_exposure')
                w1_promo_clicks = get_val(w1, 'promotion_clicks')
                w1_promo_orders = get_val(w1, 'promotion_orders')
                w1_view_groupbuy = get_val(w1, 'view_groupbuy')
                w1_view_phone = get_val(w1, 'view_phone')
                w1_consult = get_val(w1, 'consult_users')
                w1_address = get_val(w1, 'address_clicks')
                w1_collect = get_val(w1, 'new_collect')
                w1_good_reviews = get_val(w1, 'new_good_reviews')

                w1_click_price = calc_avg_price(w1_promo_cost, w1_promo_clicks)
                w1_promo_rate = f"{calc_rate(w1_promo_orders, w1_promo_clicks)}%"
                w1_collect_rate = f"{calc_rate(w1_collect, w1_visit)}%"
                w1_review_rate = f"{calc_rate(w1_good_reviews, w1_verify_users)}%"

                w2_promo_cost = get_val(w2, 'promotion_cost')
                w2_promo_exposure = get_val(w2, 'promotion_exposure')
                w2_promo_clicks = get_val(w2, 'promotion_clicks')
                w2_promo_orders = get_val(w2, 'promotion_orders')
                w2_view_groupbuy = get_val(w2, 'view_groupbuy')
                w2_view_phone = get_val(w2, 'view_phone')
                w2_consult = get_val(w2, 'consult_users')
                w2_address = get_val(w2, 'address_clicks')
                w2_collect = get_val(w2, 'new_collect')
                w2_good_reviews = get_val(w2, 'new_good_reviews')

                w2_click_price = calc_avg_price(w2_promo_cost, w2_promo_clicks)
                w2_promo_rate = f"{calc_rate(w2_promo_orders, w2_promo_clicks)}%"
                w2_collect_rate = f"{calc_rate(w2_collect, w2_visit)}%"
                w2_review_rate = f"{calc_rate(w2_good_reviews, w2_verify_users)}%"

                # æ¨å¹¿é€šå·®å€¼
                diff_promo_cost = round(w2_promo_cost - w1_promo_cost, 2)
                diff_promo_exposure = w2_promo_exposure - w1_promo_exposure
                diff_promo_clicks = w2_promo_clicks - w1_promo_clicks
                diff_click_price = round(w2_click_price - w1_click_price, 2)
                diff_promo_orders = w2_promo_orders - w1_promo_orders
                diff_promo_rate = calc_rate_diff(w1_promo_rate, w2_promo_rate)
                diff_view_groupbuy = w2_view_groupbuy - w1_view_groupbuy
                diff_view_phone = w2_view_phone - w1_view_phone
                diff_consult = w2_consult - w1_consult
                diff_address = w2_address - w1_address
                diff_collect = w2_collect - w1_collect
                diff_collect_rate = calc_rate_diff(w1_collect_rate, w2_collect_rate)
                diff_good_reviews = w2_good_reviews - w1_good_reviews
                diff_review_rate = calc_rate_diff(w1_review_rate, w2_review_rate)

                # ==================== æ±‡æ€»Sheet 8è¡Œç»“æ„ï¼ˆä¸ç¤ºä¾‹ä¸€è‡´ï¼‰====================
                # è¡Œ1: æ ¸é”€æ•°æ®è¡¨å¤´ï¼ˆå‘¨æŠ¥/æœˆæŠ¥ä¸åŒ…å«åºå·ã€è¿è¥ã€åŸå¸‚ã€é”€å”®ï¼‰
                header_row1 = [
                    'é—¨åº—', 'æ•°æ®å‘¨æœŸ', 'ä¼˜æƒ åæ ¸é”€é¢', 'æ›å…‰äººæ•°', 'è®¿é—®äººæ•°', 'æ›å…‰è®¿é—®è½¬åŒ–ç‡',
                    'ä¸‹å•äººæ•°', 'ä¸‹å•åˆ¸æ•°', 'ä¸‹å•è½¬åŒ–ç‡', 'æ ¸é”€äººæ•°', 'æ ¸é”€åˆ¸æ•°',
                    'ä¸‹å•å”®ä»·é‡‘é¢', 'æ ¸é”€å”®ä»·é‡‘é¢', 'ä¼˜æƒ ç è®¢å•', 'ç”µè¯ç‚¹å‡»', 'å®¢å•ä»·'
                ]
                ws_summary.append(header_row1)

                # è¡Œ2: ç¬¬ä¸€å‘¨æ ¸é”€æ•°æ®ï¼ˆå¸¦é—¨åº—ä¿¡æ¯ï¼‰
                row2 = [
                    shop_name, week1_period,
                    round(w1_verify_discount, 2), w1_exposure, w1_visit, w1_exposure_rate,
                    w1_order_users, w1_order_coupons, w1_order_rate,
                    w1_verify_users, w1_verify_coupons,
                    round(w1_order_amount, 2), round(w1_verify_amount, 2),
                    w1_coupon_orders, w1_phone_clicks, w1_avg_price
                ]
                ws_summary.append(row2)

                # è¡Œ3: ç¬¬äºŒå‘¨æ ¸é”€æ•°æ®ï¼ˆå‰1åˆ—ä¸ºç©ºï¼‰
                row3 = [
                    '', week2_period,
                    round(w2_verify_discount, 2), w2_exposure, w2_visit, w2_exposure_rate,
                    w2_order_users, w2_order_coupons, w2_order_rate,
                    w2_verify_users, w2_verify_coupons,
                    round(w2_order_amount, 2), round(w2_verify_amount, 2),
                    w2_coupon_orders, w2_phone_clicks, w2_avg_price
                ]
                ws_summary.append(row3)

                # è¡Œ4: æ ¸é”€å·®å€¼ï¼ˆå‰1åˆ—ä¸ºç©ºï¼‰
                row4 = [
                    '', 'å·®å€¼',
                    diff_verify_discount, diff_exposure, diff_visit, diff_exposure_rate,
                    diff_order_users, diff_order_coupons, diff_order_rate,
                    diff_verify_users, diff_verify_coupons,
                    diff_order_amount, diff_verify_amount,
                    diff_coupon_orders, diff_phone_clicks, diff_avg_price
                ]
                ws_summary.append(row4)

                # è¡Œ5: æ¨å¹¿é€šè¡¨å¤´ï¼ˆå‰1åˆ—ä¸ºç©ºï¼‰
                header_row2 = [
                    '', 'æ•°æ®å‘¨æœŸ', 'æ¨å¹¿é€šèŠ±è´¹', 'æ¨å¹¿é€šæ›å…‰', 'æ¨å¹¿é€šç‚¹å‡»', 'æ¨å¹¿é€šç‚¹å‡»å‡ä»·',
                    'æ¨å¹¿é€šè®¢å•é‡', 'æ¨å¹¿é€šä¸‹å•è½¬åŒ–ç‡', 'æ¨å¹¿é€šæŸ¥çœ‹å›¢è´­', 'æ¨å¹¿é€šæŸ¥çœ‹ç”µè¯',
                    'åœ¨çº¿å’¨è¯¢', 'åœ°å€ç‚¹å‡»', 'é—¨åº—æ”¶è—', 'æ”¶è—ç‡', 'æ–°å¢å¥½è¯„æ•°', 'ç•™è¯„ç‡'
                ]
                ws_summary.append(header_row2)

                # è¡Œ6: ç¬¬ä¸€å‘¨æ¨å¹¿é€šæ•°æ®ï¼ˆå‰1åˆ—ä¸ºç©ºï¼‰
                row6 = [
                    '', week1_period,
                    round(w1_promo_cost, 2), w1_promo_exposure, w1_promo_clicks, w1_click_price,
                    w1_promo_orders, w1_promo_rate, w1_view_groupbuy, w1_view_phone,
                    w1_consult, w1_address, w1_collect, w1_collect_rate,
                    w1_good_reviews, w1_review_rate
                ]
                ws_summary.append(row6)

                # è¡Œ7: ç¬¬äºŒå‘¨æ¨å¹¿é€šæ•°æ®ï¼ˆå‰1åˆ—ä¸ºç©ºï¼‰
                row7 = [
                    '', week2_period,
                    round(w2_promo_cost, 2), w2_promo_exposure, w2_promo_clicks, w2_click_price,
                    w2_promo_orders, w2_promo_rate, w2_view_groupbuy, w2_view_phone,
                    w2_consult, w2_address, w2_collect, w2_collect_rate,
                    w2_good_reviews, w2_review_rate
                ]
                ws_summary.append(row7)

                # è¡Œ8: æ¨å¹¿é€šå·®å€¼ï¼ˆå‰1åˆ—ä¸ºç©ºï¼‰
                row8 = [
                    '', 'å·®å€¼',
                    diff_promo_cost, diff_promo_exposure, diff_promo_clicks, diff_click_price,
                    diff_promo_orders, diff_promo_rate, diff_view_groupbuy, diff_view_phone,
                    diff_consult, diff_address, diff_collect, diff_collect_rate,
                    diff_good_reviews, diff_review_rate
                ]
                ws_summary.append(row8)

                # ==================== é—¨åº—è¯¦ç»†Sheetï¼ˆç«–å‘31è¡Œï¼‰====================
                sheet_name = clean_sheet_name(shop_name)
                if sheet_name in sheet_names_used:
                    sheet_names_used[sheet_name] += 1
                    sheet_name = f"{sheet_name[:28]}_{sheet_names_used[sheet_name]}"
                else:
                    sheet_names_used[sheet_name] = 1

                ws_detail = wb.create_sheet(title=sheet_name)

                # è®¡ç®—é¢å¤–æŒ‡æ ‡ï¼ˆç›´æ¥è®¡ç®—ç™¾åˆ†æ¯”å€¼ï¼Œä¸ä½¿ç”¨å…¬å¼ï¼‰
                w1_exposure_rate_val = f"{calc_rate(w1_visit, w1_exposure)}%" if w1_exposure > 0 else "0%"
                w2_exposure_rate_val = f"{calc_rate(w2_visit, w2_exposure)}%" if w2_exposure > 0 else "0%"
                w1_intent_rate_val = f"{calc_rate(w1_order_users, w1_visit)}%" if w1_visit > 0 else "0%"
                w2_intent_rate_val = f"{calc_rate(w2_order_users, w2_visit)}%" if w2_visit > 0 else "0%"
                w1_review_rate_val = f"{calc_rate(w1_good_reviews, w1_verify_users)}%" if w1_verify_users > 0 else "0%"
                w2_review_rate_val = f"{calc_rate(w2_good_reviews, w2_verify_users)}%" if w2_verify_users > 0 else "0%"
                w1_collect_rate_val = f"{calc_rate(w1_collect, w1_order_users)}%" if w1_order_users > 0 else "0%"
                w2_collect_rate_val = f"{calc_rate(w2_collect, w2_order_users)}%" if w2_order_users > 0 else "0%"

                w1_checkin = get_val(w1, 'checkin_count')
                w2_checkin = get_val(w2, 'checkin_count')

                # è®¡ç®—å·®å€¼ï¼ˆç”¨äºå·®å€¼åˆ—æ˜¾ç¤ºï¼‰
                diff_exposure_val = w2_exposure - w1_exposure
                diff_visit_val = w2_visit - w1_visit
                diff_exposure_rate_val = f"{round(calc_rate(w2_visit, w2_exposure) - calc_rate(w1_visit, w1_exposure), 2)}%"
                diff_order_users_val = w2_order_users - w1_order_users
                diff_verify_users_val = w2_verify_users - w1_verify_users
                diff_intent_rate_val = f"{round(calc_rate(w2_order_users, w2_visit) - calc_rate(w1_order_users, w1_visit), 2)}%"
                diff_order_coupons_val = w2_order_coupons - w1_order_coupons
                diff_verify_coupons_val = w2_verify_coupons - w1_verify_coupons
                diff_order_amount_val = round(w2_order_amount - w1_order_amount, 2)
                diff_verify_amount_val = round(w2_verify_amount - w1_verify_amount, 2)
                diff_verify_discount_val = round(w2_verify_discount - w1_verify_discount, 2)
                diff_avg_price_val = round(w2_avg_price - w1_avg_price, 2)
                diff_phone_val = w2_phone_clicks - w1_phone_clicks
                diff_address_val = w2_address - w1_address
                diff_consult_val = w2_consult - w1_consult
                diff_good_reviews_val = w2_good_reviews - w1_good_reviews
                diff_review_rate_val = f"{round(calc_rate(w2_good_reviews, w2_verify_users) - calc_rate(w1_good_reviews, w1_verify_users), 2)}%"
                diff_collect_val = w2_collect - w1_collect
                diff_collect_rate_val = f"{round(calc_rate(w2_collect, w2_order_users) - calc_rate(w1_collect, w1_order_users), 2)}%"
                diff_checkin_val = w2_checkin - w1_checkin
                diff_promo_orders_val = w2_promo_orders - w1_promo_orders
                diff_promo_cost_val = round(w2_promo_cost - w1_promo_cost, 2)
                diff_promo_exposure_val = w2_promo_exposure - w1_promo_exposure
                diff_promo_clicks_val = w2_promo_clicks - w1_promo_clicks
                diff_click_price_val = round(w2_click_price - w1_click_price, 2)
                diff_view_groupbuy_val = w2_view_groupbuy - w1_view_groupbuy
                diff_view_phone_val = w2_view_phone - w1_view_phone

                # æ„å»ºç«–å‘è¡¨æ ¼ï¼ˆ31è¡Œï¼‰- ä½¿ç”¨è®¡ç®—åçš„å€¼è€Œä¸æ˜¯å…¬å¼
                detail_data = [
                    [shop_name, '', '', ''],
                    ['æŒ‡æ ‡é¡¹/æ—¶é—´å‘¨æœŸ', week1_period, week2_period, 'å·®å€¼\nï¼ˆçº¢è‰²ä¸ºä¸Šå‡/é»‘è‰²ä¸ºä¸‹é™ï¼‰'],
                    ['æ›å…‰äººæ•°ï¼š', w1_exposure, w2_exposure, diff_exposure_val],
                    ['è®¿é—®äººæ•°ï¼š', w1_visit, w2_visit, diff_visit_val],
                    ['æ›å…‰è®¿é—®è½¬åŒ–ç‡ï¼š', w1_exposure_rate_val, w2_exposure_rate_val, diff_exposure_rate_val],
                    ['ä¸‹å•äººæ•°ï¼š', w1_order_users, w2_order_users, diff_order_users_val],
                    ['æ ¸é”€äººæ•°ï¼š', w1_verify_users, w2_verify_users, diff_verify_users_val],
                    ['æ„å‘è½¬åŒ–ç‡ï¼š', w1_intent_rate_val, w2_intent_rate_val, diff_intent_rate_val],
                    ['ä¸‹å•åˆ¸æ•°ï¼š', w1_order_coupons, w2_order_coupons, diff_order_coupons_val],
                    ['æ ¸é”€åˆ¸æ•°ï¼š', w1_verify_coupons, w2_verify_coupons, diff_verify_coupons_val],
                    ['ä¸‹å•å”®ä»·é‡‘é¢ï¼š', round(w1_order_amount, 2), round(w2_order_amount, 2), diff_order_amount_val],
                    ['æ ¸é”€å”®ä»·é‡‘é¢ï¼š', round(w1_verify_amount, 2), round(w2_verify_amount, 2), diff_verify_amount_val],
                    ['ä¼˜æƒ åæ ¸é”€é‡‘é¢ï¼š', round(w1_verify_discount, 2), round(w2_verify_discount, 2), diff_verify_discount_val],
                    ['å®¢å•ä»·ï¼š', w1_avg_price, w2_avg_price, diff_avg_price_val],
                    ['ç”µè¯ç‚¹å‡»ï¼š', w1_phone_clicks, w2_phone_clicks, diff_phone_val],
                    ['åœ°å€ç‚¹å‡»ï¼š', w1_address, w2_address, diff_address_val],
                    ['åœ¨çº¿å’¨è¯¢ï¼š', w1_consult, w2_consult, diff_consult_val],
                    ['é—¨åº—å¹²é¢„æ•°æ®', '', '', ''],
                    ['æ–°å¢å¥½è¯„ï¼š', w1_good_reviews, w2_good_reviews, diff_good_reviews_val],
                    ['ç•™è¯„ç‡ï¼š', w1_review_rate_val, w2_review_rate_val, diff_review_rate_val],
                    ['é—¨åº—æ”¶è—ï¼š', w1_collect, w2_collect, diff_collect_val],
                    ['æ”¶è—ç‡ï¼š', w1_collect_rate_val, w2_collect_rate_val, diff_collect_rate_val],
                    ['æ‰“å¡äººæ•°ï¼š', w1_checkin, w2_checkin, diff_checkin_val],
                    ['æ¨å¹¿é€šæ•°æ®', '', '', ''],
                    ['æ¨å¹¿é€šè®¢å•é‡', w1_promo_orders, w2_promo_orders, diff_promo_orders_val],
                    ['æ¨å¹¿é€šèŠ±è´¹', round(w1_promo_cost, 2), round(w2_promo_cost, 2), diff_promo_cost_val],
                    ['æ¨å¹¿é€šæ›å…‰ï¼ˆæ¬¡ï¼‰', w1_promo_exposure, w2_promo_exposure, diff_promo_exposure_val],
                    ['æ¨å¹¿é€šç‚¹å‡»ï¼ˆæ¬¡ï¼‰', w1_promo_clicks, w2_promo_clicks, diff_promo_clicks_val],
                    ['æ¨å¹¿é€šç‚¹å‡»å‡ä»·ï¼ˆå…ƒï¼‰', w1_click_price, w2_click_price, diff_click_price_val],
                    ['æŸ¥çœ‹å›¢è´­ï¼ˆæ¬¡ï¼‰', w1_view_groupbuy, w2_view_groupbuy, diff_view_groupbuy_val],
                    ['æŸ¥çœ‹ç”µè¯ï¼ˆæ¬¡ï¼‰', w1_view_phone, w2_view_phone, diff_view_phone_val],
                ]

                for row_data in detail_data:
                    ws_detail.append(row_data)

                # åˆå¹¶é—¨åº—åå•å…ƒæ ¼ A1:D1
                ws_detail.merge_cells('A1:D1')

                # åˆå¹¶ç¬¬18è¡Œå’Œç¬¬24è¡Œçš„A:Då•å…ƒæ ¼
                ws_detail.merge_cells('A18:D18')
                ws_detail.merge_cells('A24:D24')

                # è®¾ç½®è¯¦ç»†Sheetæ ·å¼ - åˆ—å®½: A=25, B=36, C=36, D=20
                ws_detail.column_dimensions['A'].width = 25
                ws_detail.column_dimensions['B'].width = 36
                ws_detail.column_dimensions['C'].width = 36
                ws_detail.column_dimensions['D'].width = 20

                # è®¾ç½®è¡Œé«˜ï¼šç¬¬1è¡Œ=31ï¼Œç¬¬2è¡Œåˆ°æœ€å=20
                ws_detail.row_dimensions[1].height = 31
                for row_num in range(2, len(detail_data) + 1):
                    ws_detail.row_dimensions[row_num].height = 20

                # å®šä¹‰é¢œè‰²
                header_fill = PatternFill(start_color="BDD7EE", end_color="BDD7EE", fill_type="solid")  # RGB(189,215,238)
                a_col_fill = PatternFill(start_color="DEEBF7", end_color="DEEBF7", fill_type="solid")  # RGB(222,235,247)

                # å®šä¹‰å­—ä½“ - å®‹ä½“ï¼ˆSimSunï¼‰
                title_font = Font(name='å®‹ä½“', size=16, color="000000")
                bcd_font = Font(name='å®‹ä½“', size=14, color="000000")

                # æ ‡é¢˜æ ·å¼ - é—¨åº—åå±…ä¸­åŠ ç²—ï¼Œå®‹ä½“16å·
                ws_detail['A1'].font = Font(name='å®‹ä½“', bold=True, size=16, color="000000")
                ws_detail['A1'].alignment = Alignment(horizontal='center', vertical='center')

                # ç¬¬2è¡Œï¼ˆæ ‡é¢˜è¡Œï¼‰æ ·å¼ - èƒŒæ™¯è‰²#BDD7EEï¼Œå®‹ä½“16å·é»‘è‰²
                for col in range(1, 5):
                    cell = ws_detail.cell(row=2, column=col)
                    cell.font = Font(name='å®‹ä½“', bold=True, size=16, color="000000")
                    cell.fill = header_fill
                    cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)

                # ç¬¬18è¡Œå’Œç¬¬24è¡Œæ ·å¼ - èƒŒæ™¯è‰²#BDD7EEï¼Œå®‹ä½“16å·é»‘è‰²
                for r in [18, 24]:
                    cell = ws_detail.cell(row=r, column=1)
                    cell.font = Font(name='å®‹ä½“', bold=True, size=16, color="000000")
                    cell.fill = header_fill
                    cell.alignment = Alignment(horizontal='center', vertical='center')

                # Aåˆ—å…¶ä»–è¡ŒèƒŒæ™¯è‰² #DEEBF7ï¼ŒB/C/Dåˆ—å­—ä½“å®‹ä½“14å·
                for row_num in range(3, len(detail_data) + 1):
                    if row_num not in [18, 24]:  # è·³è¿‡å·²å¤„ç†çš„åˆ†ç±»æ ‡é¢˜è¡Œ
                        # Aåˆ—èƒŒæ™¯è‰²
                        ws_detail.cell(row=row_num, column=1).fill = a_col_fill
                        ws_detail.cell(row=row_num, column=1).font = Font(name='å®‹ä½“', size=14, color="000000")
                        # B/C/Dåˆ—å­—ä½“
                        for col in range(2, 5):
                            ws_detail.cell(row=row_num, column=col).font = bcd_font

                # åº”ç”¨è¾¹æ¡†
                apply_border(ws_detail, 1, len(detail_data), 1, 4)

                # æ‰€æœ‰å•å…ƒæ ¼å±…ä¸­å¯¹é½
                for row_num in range(1, len(detail_data) + 1):
                    for col_num in range(1, 5):
                        ws_detail.cell(row=row_num, column=col_num).alignment = Alignment(horizontal='center', vertical='center')

                # è®¾ç½®å·®å€¼åˆ—é¢œè‰²ï¼ˆæ­£æ•°çº¢è‰²ï¼Œè´Ÿæ•°é»‘è‰²ï¼‰- ä¿æŒå®‹ä½“14å·
                for row_num in range(3, len(detail_data) + 1):
                    if row_num in [18, 24]:  # è·³è¿‡åˆ†ç±»æ ‡é¢˜è¡Œ
                        continue
                    cell = ws_detail.cell(row=row_num, column=4)
                    cell_value = cell.value
                    # åˆ¤æ–­æ˜¯å¦ä¸ºæ­£æ•°ï¼ˆæ•°å€¼æˆ–ç™¾åˆ†æ¯”å­—ç¬¦ä¸²ï¼‰
                    is_positive = False
                    if isinstance(cell_value, (int, float)):
                        is_positive = cell_value > 0
                    elif isinstance(cell_value, str) and '%' in cell_value:
                        try:
                            num_val = float(cell_value.replace('%', ''))
                            is_positive = num_val > 0
                        except:
                            pass
                    if is_positive:
                        cell.font = Font(name='å®‹ä½“', size=14, color="FF0000")

            except Exception as e:
                # æ•è·é”™è¯¯å¹¶æ‰“å°è¯¦ç»†è°ƒè¯•ä¿¡æ¯
                print(f"\n{'âŒ' * 30}")
                print(f"âŒ å¤„ç†é—¨åº—æ—¶å‡ºé”™: {shop_name} (ID: {shop_id})")
                print(f"âŒ é”™è¯¯ç±»å‹: {type(e).__name__}")
                print(f"âŒ é”™è¯¯ä¿¡æ¯: {str(e)}")
                print(f"{'âŒ' * 30}")

                # æ‰“å°ç¬¬ä¸€å‘¨æ•°æ®
                debug_print_row(shop_id, shop_name, w1, "ç¬¬ä¸€å‘¨æ•°æ® (week1_data)")

                # æ‰“å°ç¬¬äºŒå‘¨æ•°æ®
                debug_print_row(shop_id, shop_name, w2, "ç¬¬äºŒå‘¨æ•°æ® (week2_data)")

                # æ‰“å°å®Œæ•´çš„å †æ ˆè·Ÿè¸ª
                print("\nğŸ“‹ å®Œæ•´é”™è¯¯å †æ ˆ:")
                traceback.print_exc()

                # è®°å½•å‡ºé”™çš„é—¨åº—
                error_shops.append({
                    'shop_id': shop_id,
                    'shop_name': shop_name,
                    'error': str(e),
                    'w1_data': w1,
                    'w2_data': w2
                })

                # ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªé—¨åº—
                continue

        # æ±‡æ€»è¡¨æ ·å¼ï¼ˆå‘¨æŠ¥/æœˆæŠ¥ä¸å«åºå·ã€è¿è¥ã€åŸå¸‚ã€é”€å”®å››åˆ—ï¼‰
        # è®¾ç½®åˆ—å®½ï¼šAåˆ—(é—¨åº—)=78ï¼ŒBåˆ—(æ•°æ®å‘¨æœŸ)=26ï¼Œå…¶ä»–åˆ—=15
        ws_summary.column_dimensions['A'].width = 78
        ws_summary.column_dimensions['B'].width = 26
        for i in range(3, 17):
            ws_summary.column_dimensions[get_column_letter(i)].width = 15

        thin_border = Border(
            left=Side(style='thin'),
            right=Side(style='thin'),
            top=Side(style='thin'),
            bottom=Side(style='thin')
        )

        # æµ…ç»¿è‰²èƒŒæ™¯ï¼ˆé—¨åº—è¡Œï¼‰#CCFFCC = RGB(204,255,204)
        green_fill = PatternFill(start_color="CCFFCC", end_color="CCFFCC", fill_type="solid")
        # çº¢è‰²å­—ä½“
        red_font = Font(color="FF0000")

        for row in ws_summary.iter_rows(min_row=1, max_row=ws_summary.max_row, min_col=1, max_col=16):
            for cell in row:
                cell.border = thin_border
                cell.alignment = Alignment(horizontal='center', vertical='center')

                # è¡¨å¤´è¡Œï¼ˆç¬¬1åˆ—ä¸º"é—¨åº—"ï¼‰- æµ…ç»¿è‰²èƒŒæ™¯åŠ ç²—
                if cell.column == 1 and cell.value == 'é—¨åº—':
                    for c in row:
                        c.font = Font(bold=True, size=10)
                        c.fill = green_fill
                elif cell.column == 2 and cell.value == 'æ•°æ®å‘¨æœŸ' and ws_summary.cell(row[0].row, 1).value == '':
                    for c in row:
                        c.font = Font(bold=True, size=10)
                        c.fill = green_fill

                # å·®å€¼è¡Œ - "å·®å€¼"æ–‡å­—çº¢è‰²ï¼Œæ•°å€¼çº¢è‰²ï¼Œä¸è®¾ç°è‰²èƒŒæ™¯
                if cell.column == 2 and cell.value == 'å·®å€¼':
                    for c in row:
                        # å·®å€¼è¡Œæ‰€æœ‰æ•°å€¼éƒ½è®¾ä¸ºçº¢è‰²
                        if c.column == 2:  # "å·®å€¼"æ–‡å­—æœ¬èº«ä¹Ÿçº¢è‰²
                            c.font = red_font
                        elif c.column > 2:  # æ•°å€¼åˆ—çº¢è‰²
                            c.font = red_font

        # åˆå¹¶Aåˆ—å•å…ƒæ ¼ï¼šæ¯ä¸ªé—¨åº—8è¡Œï¼Œåˆå¹¶ç¬¬2-8è¡Œï¼ˆé—¨åº—åè¡Œåˆ°å·®å€¼è¡Œï¼‰
        # è§„åˆ™ï¼šç¬¬1è¡Œæ˜¯è¡¨å¤´ï¼Œç¬¬2è¡Œæ˜¯é—¨åº—åï¼Œç¬¬3-8è¡ŒAåˆ—ä¸ºç©ºéœ€è¦åˆå¹¶
        # å³åˆå¹¶ 2-8, 10-16, 18-24, 26-32 ...
        row_idx = 2  # ä»ç¬¬2è¡Œå¼€å§‹ï¼ˆç¬¬ä¸€ä¸ªé—¨åº—åè¡Œï¼‰
        while row_idx <= ws_summary.max_row:
            merge_end = row_idx + 6  # åˆå¹¶7è¡Œ (row_idx åˆ° row_idx+6)
            if merge_end <= ws_summary.max_row:
                # åªåˆå¹¶Aåˆ—ï¼ˆé—¨åº—ï¼‰
                ws_summary.merge_cells(start_row=row_idx, start_column=1, end_row=merge_end, end_column=1)
            row_idx += 8  # è·³åˆ°ä¸‹ä¸€ä¸ªé—¨åº—å—

        # ä¿å­˜æ–‡ä»¶
        if not output_filename:
            output_filename = f"å‘¨æŠ¥ éé¤ {week2_start.replace('-', '')}~{week2_end.replace('-', '')} {datetime.now().strftime('%Y%m%d%H%M%S')}.xlsx"

        wb.save(output_filename)

        # æ‰“å°æ±‡æ€»ä¿¡æ¯
        if error_shops:
            print(f"\n{'=' * 60}")
            print(f"âš ï¸ è­¦å‘Š: æœ‰ {len(error_shops)} ä¸ªé—¨åº—å¤„ç†å¤±è´¥:")
            for err in error_shops:
                print(f"  - {err['shop_name']} (ID: {err['shop_id']}): {err['error']}")
            print(f"{'=' * 60}")

        print(f"âœ… å‘¨æŠ¥ç”ŸæˆæˆåŠŸ: {output_filename}")
        return output_filename

    finally:
        cursor.close()
        conn.close()


# ==================== æ ¸å¿ƒåŠŸèƒ½ï¼šç”ŸæˆæœˆæŠ¥ ====================
def generate_monthly_report(month1_start, month1_end, month2_start, month2_end, output_filename=None):
    """
    ç”ŸæˆæœˆæŠ¥ï¼ˆä¸¤ä¸ªæœˆå¯¹æ¯”ï¼‰
    ç»“æ„ä¸å‘¨æŠ¥å®Œå…¨ç›¸åŒï¼Œåªæ˜¯æ—¶é—´è·¨åº¦ä»å‘¨å˜ä¸ºæœˆ

    å‚æ•°:
        month1_start: str, ç¬¬ä¸€ä¸ªæœˆå¼€å§‹æ—¥æœŸ 'YYYY-MM-DD'
        month1_end: str, ç¬¬ä¸€ä¸ªæœˆç»“æŸæ—¥æœŸ 'YYYY-MM-DD'
        month2_start: str, ç¬¬äºŒä¸ªæœˆå¼€å§‹æ—¥æœŸ 'YYYY-MM-DD'
        month2_end: str, ç¬¬äºŒä¸ªæœˆç»“æŸæ—¥æœŸ 'YYYY-MM-DD'
        output_filename: str, è¾“å‡ºæ–‡ä»¶å
    """
    # ç”Ÿæˆé»˜è®¤æ–‡ä»¶å
    if not output_filename:
        output_filename = f"æœˆæŠ¥ éé¤ {month2_start.replace('-', '')}~{month2_end.replace('-', '')} {datetime.now().strftime('%Y%m%d%H%M%S')}.xlsx"

    # å¤ç”¨å‘¨æŠ¥é€»è¾‘
    return generate_weekly_report(month1_start, month1_end, month2_start, month2_end, output_filename)


# ==================== æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆè‡ªå®šä¹‰æŠ¥è¡¨ ====================
def generate_custom_report(period1_start, period1_end, period2_start, period2_end, shop_ids=None, output_filename=None):
    """
    ç”Ÿæˆè‡ªå®šä¹‰æŠ¥è¡¨ï¼ˆä¸¤ä¸ªè‡ªå®šä¹‰æ—¶é—´æ®µå¯¹æ¯”ï¼Œæ”¯æŒç­›é€‰é—¨åº—ï¼‰
    ç»“æ„ä¸å‘¨æŠ¥ç›¸åŒ

    å‚æ•°:
        period1_start: str, ç¬¬ä¸€ä¸ªæ—¶æœŸå¼€å§‹æ—¥æœŸ
        period1_end: str, ç¬¬ä¸€ä¸ªæ—¶æœŸç»“æŸæ—¥æœŸ
        period2_start: str, ç¬¬äºŒä¸ªæ—¶æœŸå¼€å§‹æ—¥æœŸ
        period2_end: str, ç¬¬äºŒä¸ªæ—¶æœŸç»“æŸæ—¥æœŸ
        shop_ids: list, é—¨åº—IDåˆ—è¡¨ï¼Œä¸ºç©ºåˆ™æŸ¥è¯¢æ‰€æœ‰é—¨åº—
        output_filename: str, è¾“å‡ºæ–‡ä»¶å
    """
    # è·å–é—¨åº—ä¿¡æ¯æ˜ å°„
    shop_mapping = get_shop_info_mapping()

    conn = CONNECTION_POOL.get_connection()
    cursor = conn.cursor(dictionary=True)

    try:
        # æ„å»º SQLï¼Œæ”¯æŒé—¨åº—ç­›é€‰
        shop_filter = ""
        if shop_ids:
            shop_filter = f"AND k.shop_id IN ({','.join(map(str, shop_ids))})"

        sql_period = f"""
        SELECT
            k.shop_id,
            k.shop_name,
            k.city,
            SUM(k.verify_after_discount) as verify_after_discount,
            SUM(k.exposure_users) as exposure_users,
            SUM(k.visit_users) as visit_users,
            SUM(k.order_users) as order_users,
            SUM(k.order_coupon_count) as order_coupon_count,
            SUM(k.verify_person_count) as verify_users,
            SUM(k.verify_coupon_count) as verify_coupon_count,
            SUM(k.order_sale_amount) as order_sale_amount,
            SUM(k.verify_sale_amount) as verify_sale_amount,
            SUM(k.coupon_pay_order_count) as coupon_orders,
            SUM(p.view_phone_count) as phone_clicks,
            SUM(k.promotion_cost) as promotion_cost,
            SUM(k.promotion_exposure_count) as promotion_exposure,
            SUM(k.promotion_click_count) as promotion_clicks,
            SUM(p.order_count) as promotion_orders,
            SUM(p.view_groupbuy_count) as view_groupbuy,
            SUM(p.view_phone_count) as view_phone,
            SUM(k.consult_users) as consult_users,
            SUM(p.view_address_count) as address_clicks,
            SUM(k.new_collect_users) as new_collect,
            SUM(k.new_good_review_count) as new_good_reviews,
            SUM(k.new_review_count) as new_reviews,
            SUM(s.checkin_count) as checkin_count
        FROM kewen_daily_report k
        LEFT JOIN promotion_daily_report p
            ON k.shop_id = p.shop_id AND k.report_date = p.report_date
        LEFT JOIN store_stats s
            ON k.shop_id = s.store_id AND k.report_date = s.date
        WHERE k.report_date BETWEEN %s AND %s {shop_filter}
        GROUP BY k.shop_id, k.shop_name, k.city
        ORDER BY k.shop_id
        """

        # è·å–ä¸¤ä¸ªæ—¶æœŸçš„æ•°æ®
        cursor.execute(sql_period, (period1_start, period1_end))
        period1_data = {row['shop_id']: row for row in cursor.fetchall()}

        cursor.execute(sql_period, (period2_start, period2_end))
        period2_data = {row['shop_id']: row for row in cursor.fetchall()}

        all_shop_ids_set = set(period1_data.keys()) | set(period2_data.keys())

        if not all_shop_ids_set:
            print("è­¦å‘Šï¼šæ²¡æœ‰æ‰¾åˆ°æ•°æ®")
            return None

        print(f"ğŸ“Š æ‰¾åˆ° {len(all_shop_ids_set)} ä¸ªé—¨åº—æ•°æ®")

        # åˆ›å»º Excel
        wb = openpyxl.Workbook()
        ws_summary = wb.active
        ws_summary.title = "è‡ªå®šä¹‰æŠ¥è¡¨"

        # æ ¼å¼åŒ–æ—¥æœŸå‘¨æœŸ
        period1_str = f"{datetime.strptime(period1_start, '%Y-%m-%d').strftime('%Y.%m.%d')}-{datetime.strptime(period1_end, '%Y-%m-%d').strftime('%Y.%m.%d')}"
        period2_str = f"{datetime.strptime(period2_start, '%Y-%m-%d').strftime('%Y.%m.%d')}-{datetime.strptime(period2_end, '%Y-%m-%d').strftime('%Y.%m.%d')}"

        # è¾…åŠ©å‡½æ•° - å®‰å…¨ç‰ˆæœ¬
        def get_val(data, key, default=0):
            """å®‰å…¨è·å–å€¼ï¼Œå¤„ç†None"""
            if not data:
                return default
            value = data.get(key)
            if value is None:
                return default
            return value

        def calc_rate(numerator, denominator):
            if denominator and denominator > 0:
                return round(numerator / denominator * 100, 1)
            return 0

        def calc_avg_price(total, count):
            if count and count > 0:
                return round(total / count, 2)
            return 0

        # ç”¨äºå¤„ç†é‡å Sheet
        sheet_names_used = {}
        seq_num = 1

        # è®°å½•æœ‰é—®é¢˜çš„é—¨åº—
        error_shops = []

        for shop_id in sorted(all_shop_ids_set):
            p1 = period1_data.get(shop_id, {})
            p2 = period2_data.get(shop_id, {})
            shop_name = p2.get('shop_name') or p1.get('shop_name', 'æœªçŸ¥é—¨åº—')

            # ä»æ˜ å°„ä¸­è·å–è¿è¥ã€åŸå¸‚ã€é”€å”®
            shop_id_str = str(shop_id)
            shop_info = shop_mapping.get(shop_id_str, {})
            operator = shop_info.get('operator', '--') or '--'
            sales = shop_info.get('sales', '--') or '--'
            city = shop_info.get('city', '--') or '--'

            try:
                # ==================== æ±‡æ€»è¡¨æ•°æ®ï¼ˆä¸å‘¨æŠ¥ç›¸åŒçš„8è¡Œç»“æ„ï¼‰====================
                # æ—¶æœŸ1æŒ‡æ ‡
                p1_verify_discount = get_val(p1, 'verify_after_discount')
                p1_exposure = get_val(p1, 'exposure_users')
                p1_visit = get_val(p1, 'visit_users')
                p1_order_users = get_val(p1, 'order_users')
                p1_order_coupons = get_val(p1, 'order_coupon_count')
                p1_verify_users = get_val(p1, 'verify_users')
                p1_verify_coupons = get_val(p1, 'verify_coupon_count')
                p1_order_amount = get_val(p1, 'order_sale_amount')
                p1_verify_amount = get_val(p1, 'verify_sale_amount')
                p1_coupon_orders = get_val(p1, 'coupon_orders')
                p1_phone_clicks = get_val(p1, 'phone_clicks')

                p1_exposure_rate = f"{calc_rate(p1_visit, p1_exposure)}%"
                p1_order_rate = f"{calc_rate(p1_order_users, p1_visit)}%"
                p1_avg_price = calc_avg_price(p1_verify_discount, p1_verify_users)

                # æ—¶æœŸ2æŒ‡æ ‡
                p2_verify_discount = get_val(p2, 'verify_after_discount')
                p2_exposure = get_val(p2, 'exposure_users')
                p2_visit = get_val(p2, 'visit_users')
                p2_order_users = get_val(p2, 'order_users')
                p2_order_coupons = get_val(p2, 'order_coupon_count')
                p2_verify_users = get_val(p2, 'verify_users')
                p2_verify_coupons = get_val(p2, 'verify_coupon_count')
                p2_order_amount = get_val(p2, 'order_sale_amount')
                p2_verify_amount = get_val(p2, 'verify_sale_amount')
                p2_coupon_orders = get_val(p2, 'coupon_orders')
                p2_phone_clicks = get_val(p2, 'phone_clicks')

                p2_exposure_rate = f"{calc_rate(p2_visit, p2_exposure)}%"
                p2_order_rate = f"{calc_rate(p2_order_users, p2_visit)}%"
                p2_avg_price = calc_avg_price(p2_verify_discount, p2_verify_users)

                # å·®å€¼è®¡ç®—
                diff_verify_discount = round(p2_verify_discount - p1_verify_discount, 2)
                diff_exposure = p2_exposure - p1_exposure
                diff_visit = p2_visit - p1_visit

                def calc_rate_diff(rate1_str, rate2_str):
                    val1 = float(rate1_str.rstrip('%')) if rate1_str != '0%' else 0
                    val2 = float(rate2_str.rstrip('%')) if rate2_str != '0%' else 0
                    return f"{round(val2 - val1, 1)}%"

                diff_exposure_rate = calc_rate_diff(p1_exposure_rate, p2_exposure_rate)
                diff_order_users = p2_order_users - p1_order_users
                diff_order_coupons = p2_order_coupons - p1_order_coupons
                diff_order_rate = calc_rate_diff(p1_order_rate, p2_order_rate)
                diff_verify_users = p2_verify_users - p1_verify_users
                diff_verify_coupons = p2_verify_coupons - p1_verify_coupons
                diff_order_amount = round(p2_order_amount - p1_order_amount, 2)
                diff_verify_amount = round(p2_verify_amount - p1_verify_amount, 2)
                diff_coupon_orders = p2_coupon_orders - p1_coupon_orders
                diff_phone_clicks = p2_phone_clicks - p1_phone_clicks
                diff_avg_price = round(p2_avg_price - p1_avg_price, 2)

                # æ¨å¹¿é€šæ•°æ®
                p1_promo_cost = get_val(p1, 'promotion_cost')
                p1_promo_exposure = get_val(p1, 'promotion_exposure')
                p1_promo_clicks = get_val(p1, 'promotion_clicks')
                p1_promo_orders = get_val(p1, 'promotion_orders')
                p1_view_groupbuy = get_val(p1, 'view_groupbuy')
                p1_view_phone = get_val(p1, 'view_phone')
                p1_consult = get_val(p1, 'consult_users')
                p1_address = get_val(p1, 'address_clicks')
                p1_collect = get_val(p1, 'new_collect')
                p1_good_reviews = get_val(p1, 'new_good_reviews')
                p1_click_price = calc_avg_price(p1_promo_cost, p1_promo_clicks)
                p1_promo_rate = f"{calc_rate(p1_promo_orders, p1_promo_clicks)}%"
                p1_collect_rate = f"{calc_rate(p1_collect, p1_visit)}%"
                p1_review_rate = f"{calc_rate(p1_good_reviews, p1_verify_users)}%"

                p2_promo_cost = get_val(p2, 'promotion_cost')
                p2_promo_exposure = get_val(p2, 'promotion_exposure')
                p2_promo_clicks = get_val(p2, 'promotion_clicks')
                p2_promo_orders = get_val(p2, 'promotion_orders')
                p2_view_groupbuy = get_val(p2, 'view_groupbuy')
                p2_view_phone = get_val(p2, 'view_phone')
                p2_consult = get_val(p2, 'consult_users')
                p2_address = get_val(p2, 'address_clicks')
                p2_collect = get_val(p2, 'new_collect')
                p2_good_reviews = get_val(p2, 'new_good_reviews')
                p2_click_price = calc_avg_price(p2_promo_cost, p2_promo_clicks)
                p2_promo_rate = f"{calc_rate(p2_promo_orders, p2_promo_clicks)}%"
                p2_collect_rate = f"{calc_rate(p2_collect, p2_visit)}%"
                p2_review_rate = f"{calc_rate(p2_good_reviews, p2_verify_users)}%"

                diff_promo_cost = round(p2_promo_cost - p1_promo_cost, 2)
                diff_promo_exposure = p2_promo_exposure - p1_promo_exposure
                diff_promo_clicks = p2_promo_clicks - p1_promo_clicks
                diff_click_price = round(p2_click_price - p1_click_price, 2)
                diff_promo_orders = p2_promo_orders - p1_promo_orders
                diff_promo_rate = calc_rate_diff(p1_promo_rate, p2_promo_rate)
                diff_view_groupbuy = p2_view_groupbuy - p1_view_groupbuy
                diff_view_phone = p2_view_phone - p1_view_phone
                diff_consult = p2_consult - p1_consult
                diff_address = p2_address - p1_address
                diff_collect = p2_collect - p1_collect
                diff_collect_rate = calc_rate_diff(p1_collect_rate, p2_collect_rate)
                diff_good_reviews = p2_good_reviews - p1_good_reviews
                diff_review_rate = calc_rate_diff(p1_review_rate, p2_review_rate)

                # ==================== æ±‡æ€»Sheet 8è¡Œç»“æ„ï¼ˆä¸å‘¨æŠ¥ä¸€è‡´ï¼‰====================
                # è¡Œ1: æ ¸é”€æ•°æ®è¡¨å¤´ï¼ˆæ–°å¢4åˆ—ï¼šåºå·ã€è¿è¥ã€åŸå¸‚ã€é”€å”®ï¼‰
                header_row1 = [
                    'åºå·', 'è¿è¥', 'åŸå¸‚', 'é”€å”®', 'é—¨åº—', 'æ•°æ®å‘¨æœŸ', 'ä¼˜æƒ åæ ¸é”€é¢', 'æ›å…‰äººæ•°', 'è®¿é—®äººæ•°', 'æ›å…‰è®¿é—®è½¬åŒ–ç‡',
                    'ä¸‹å•äººæ•°', 'ä¸‹å•åˆ¸æ•°', 'ä¸‹å•è½¬åŒ–ç‡', 'æ ¸é”€äººæ•°', 'æ ¸é”€åˆ¸æ•°',
                    'ä¸‹å•å”®ä»·é‡‘é¢', 'æ ¸é”€å”®ä»·é‡‘é¢', 'ä¼˜æƒ ç è®¢å•', 'ç”µè¯ç‚¹å‡»', 'å®¢å•ä»·'
                ]
                ws_summary.append(header_row1)

                # è¡Œ2: ç¬¬ä¸€ä¸ªæ—¶æœŸæ ¸é”€æ•°æ®ï¼ˆå¸¦é—¨åº—ä¿¡æ¯ï¼‰
                row2 = [
                    seq_num, operator, city, sales, shop_name, period1_str,
                    round(p1_verify_discount, 2), p1_exposure, p1_visit, p1_exposure_rate,
                    p1_order_users, p1_order_coupons, p1_order_rate,
                    p1_verify_users, p1_verify_coupons,
                    round(p1_order_amount, 2), round(p1_verify_amount, 2),
                    p1_coupon_orders, p1_phone_clicks, p1_avg_price
                ]
                ws_summary.append(row2)

                # è¡Œ3: ç¬¬äºŒä¸ªæ—¶æœŸæ ¸é”€æ•°æ®ï¼ˆå‰5åˆ—ä¸ºç©ºï¼‰
                row3 = [
                    '', '', '', '', '', period2_str,
                    round(p2_verify_discount, 2), p2_exposure, p2_visit, p2_exposure_rate,
                    p2_order_users, p2_order_coupons, p2_order_rate,
                    p2_verify_users, p2_verify_coupons,
                    round(p2_order_amount, 2), round(p2_verify_amount, 2),
                    p2_coupon_orders, p2_phone_clicks, p2_avg_price
                ]
                ws_summary.append(row3)

                # è¡Œ4: æ ¸é”€å·®å€¼ï¼ˆå‰5åˆ—ä¸ºç©ºï¼‰
                row4 = [
                    '', '', '', '', '', 'å·®å€¼',
                    diff_verify_discount, diff_exposure, diff_visit, diff_exposure_rate,
                    diff_order_users, diff_order_coupons, diff_order_rate,
                    diff_verify_users, diff_verify_coupons,
                    diff_order_amount, diff_verify_amount,
                    diff_coupon_orders, diff_phone_clicks, diff_avg_price
                ]
                ws_summary.append(row4)

                # è¡Œ5: æ¨å¹¿é€šè¡¨å¤´ï¼ˆå‰5åˆ—ä¸ºç©ºï¼‰
                header_row2 = [
                    '', '', '', '', '', 'æ•°æ®å‘¨æœŸ', 'æ¨å¹¿é€šèŠ±è´¹', 'æ¨å¹¿é€šæ›å…‰', 'æ¨å¹¿é€šç‚¹å‡»', 'æ¨å¹¿é€šç‚¹å‡»å‡ä»·',
                    'æ¨å¹¿é€šè®¢å•é‡', 'æ¨å¹¿é€šä¸‹å•è½¬åŒ–ç‡', 'æ¨å¹¿é€šæŸ¥çœ‹å›¢è´­', 'æ¨å¹¿é€šæŸ¥çœ‹ç”µè¯',
                    'åœ¨çº¿å’¨è¯¢', 'åœ°å€ç‚¹å‡»', 'é—¨åº—æ”¶è—', 'æ”¶è—ç‡', 'æ–°å¢å¥½è¯„æ•°', 'ç•™è¯„ç‡'
                ]
                ws_summary.append(header_row2)

                # è¡Œ6: ç¬¬ä¸€ä¸ªæ—¶æœŸæ¨å¹¿é€šæ•°æ®ï¼ˆå‰5åˆ—ä¸ºç©ºï¼‰
                row6 = [
                    '', '', '', '', '', period1_str,
                    round(p1_promo_cost, 2), p1_promo_exposure, p1_promo_clicks, p1_click_price,
                    p1_promo_orders, p1_promo_rate, p1_view_groupbuy, p1_view_phone,
                    p1_consult, p1_address, p1_collect, p1_collect_rate,
                    p1_good_reviews, p1_review_rate
                ]
                ws_summary.append(row6)

                # è¡Œ7: ç¬¬äºŒä¸ªæ—¶æœŸæ¨å¹¿é€šæ•°æ®ï¼ˆå‰5åˆ—ä¸ºç©ºï¼‰
                row7 = [
                    '', '', '', '', '', period2_str,
                    round(p2_promo_cost, 2), p2_promo_exposure, p2_promo_clicks, p2_click_price,
                    p2_promo_orders, p2_promo_rate, p2_view_groupbuy, p2_view_phone,
                    p2_consult, p2_address, p2_collect, p2_collect_rate,
                    p2_good_reviews, p2_review_rate
                ]
                ws_summary.append(row7)

                # è¡Œ8: æ¨å¹¿é€šå·®å€¼ï¼ˆå‰5åˆ—ä¸ºç©ºï¼‰
                row8 = [
                    '', '', '', '', '', 'å·®å€¼',
                    diff_promo_cost, diff_promo_exposure, diff_promo_clicks, diff_click_price,
                    diff_promo_orders, diff_promo_rate, diff_view_groupbuy, diff_view_phone,
                    diff_consult, diff_address, diff_collect, diff_collect_rate,
                    diff_good_reviews, diff_review_rate
                ]
                ws_summary.append(row8)

                # ==================== é—¨åº—è¯¦ç»†Sheetï¼ˆç«–å‘31è¡Œï¼‰====================
                sheet_name = clean_sheet_name(shop_name)
                if sheet_name in sheet_names_used:
                    sheet_names_used[sheet_name] += 1
                    sheet_name = f"{sheet_name[:28]}_{sheet_names_used[sheet_name]}"
                else:
                    sheet_names_used[sheet_name] = 1

                ws_detail = wb.create_sheet(title=sheet_name)

                # è®¡ç®—é¢å¤–æŒ‡æ ‡ï¼ˆç›´æ¥è®¡ç®—ç™¾åˆ†æ¯”å€¼ï¼Œä¸ä½¿ç”¨å…¬å¼ï¼‰
                p1_exposure_rate_val = f"{calc_rate(p1_visit, p1_exposure)}%" if p1_exposure > 0 else "0%"
                p2_exposure_rate_val = f"{calc_rate(p2_visit, p2_exposure)}%" if p2_exposure > 0 else "0%"
                p1_intent_rate_val = f"{calc_rate(p1_order_users, p1_visit)}%" if p1_visit > 0 else "0%"
                p2_intent_rate_val = f"{calc_rate(p2_order_users, p2_visit)}%" if p2_visit > 0 else "0%"
                p1_review_rate_val = f"{calc_rate(p1_good_reviews, p1_verify_users)}%" if p1_verify_users > 0 else "0%"
                p2_review_rate_val = f"{calc_rate(p2_good_reviews, p2_verify_users)}%" if p2_verify_users > 0 else "0%"
                p1_collect_rate_val = f"{calc_rate(p1_collect, p1_order_users)}%" if p1_order_users > 0 else "0%"
                p2_collect_rate_val = f"{calc_rate(p2_collect, p2_order_users)}%" if p2_order_users > 0 else "0%"

                p1_checkin = get_val(p1, 'checkin_count')
                p2_checkin = get_val(p2, 'checkin_count')

                # è®¡ç®—å·®å€¼
                diff_exposure_val = p2_exposure - p1_exposure
                diff_visit_val = p2_visit - p1_visit
                diff_exposure_rate_val = f"{round(calc_rate(p2_visit, p2_exposure) - calc_rate(p1_visit, p1_exposure), 2)}%"
                diff_order_users_val = p2_order_users - p1_order_users
                diff_verify_users_val = p2_verify_users - p1_verify_users
                diff_intent_rate_val = f"{round(calc_rate(p2_order_users, p2_visit) - calc_rate(p1_order_users, p1_visit), 2)}%"
                diff_order_coupons_val = p2_order_coupons - p1_order_coupons
                diff_verify_coupons_val = p2_verify_coupons - p1_verify_coupons
                diff_order_amount_val = round(p2_order_amount - p1_order_amount, 2)
                diff_verify_amount_val = round(p2_verify_amount - p1_verify_amount, 2)
                diff_verify_discount_val = round(p2_verify_discount - p1_verify_discount, 2)
                diff_avg_price_val = round(p2_avg_price - p1_avg_price, 2)
                diff_phone_val = p2_phone_clicks - p1_phone_clicks
                diff_address_val = p2_address - p1_address
                diff_consult_val = p2_consult - p1_consult
                diff_good_reviews_val = p2_good_reviews - p1_good_reviews
                diff_review_rate_val = f"{round(calc_rate(p2_good_reviews, p2_verify_users) - calc_rate(p1_good_reviews, p1_verify_users), 2)}%"
                diff_collect_val = p2_collect - p1_collect
                diff_collect_rate_val = f"{round(calc_rate(p2_collect, p2_order_users) - calc_rate(p1_collect, p1_order_users), 2)}%"
                diff_checkin_val = p2_checkin - p1_checkin
                diff_promo_orders_val = p2_promo_orders - p1_promo_orders
                diff_promo_cost_val = round(p2_promo_cost - p1_promo_cost, 2)
                diff_promo_exposure_val = p2_promo_exposure - p1_promo_exposure
                diff_promo_clicks_val = p2_promo_clicks - p1_promo_clicks
                diff_click_price_val = round(p2_click_price - p1_click_price, 2)
                diff_view_groupbuy_val = p2_view_groupbuy - p1_view_groupbuy
                diff_view_phone_val = p2_view_phone - p1_view_phone

                # æ„å»ºç«–å‘è¡¨æ ¼ï¼ˆ31è¡Œï¼‰- ä½¿ç”¨è®¡ç®—åçš„å€¼è€Œä¸æ˜¯å…¬å¼
                detail_data = [
                    [shop_name, '', '', ''],
                    ['æŒ‡æ ‡é¡¹/æ—¶é—´å‘¨æœŸ', period1_str, period2_str, 'å·®å€¼\nï¼ˆçº¢è‰²ä¸ºä¸Šå‡/é»‘è‰²ä¸ºä¸‹é™ï¼‰'],
                    ['æ›å…‰äººæ•°ï¼š', p1_exposure, p2_exposure, diff_exposure_val],
                    ['è®¿é—®äººæ•°ï¼š', p1_visit, p2_visit, diff_visit_val],
                    ['æ›å…‰è®¿é—®è½¬åŒ–ç‡ï¼š', p1_exposure_rate_val, p2_exposure_rate_val, diff_exposure_rate_val],
                    ['ä¸‹å•äººæ•°ï¼š', p1_order_users, p2_order_users, diff_order_users_val],
                    ['æ ¸é”€äººæ•°ï¼š', p1_verify_users, p2_verify_users, diff_verify_users_val],
                    ['æ„å‘è½¬åŒ–ç‡ï¼š', p1_intent_rate_val, p2_intent_rate_val, diff_intent_rate_val],
                    ['ä¸‹å•åˆ¸æ•°ï¼š', p1_order_coupons, p2_order_coupons, diff_order_coupons_val],
                    ['æ ¸é”€åˆ¸æ•°ï¼š', p1_verify_coupons, p2_verify_coupons, diff_verify_coupons_val],
                    ['ä¸‹å•å”®ä»·é‡‘é¢ï¼š', round(p1_order_amount, 2), round(p2_order_amount, 2), diff_order_amount_val],
                    ['æ ¸é”€å”®ä»·é‡‘é¢ï¼š', round(p1_verify_amount, 2), round(p2_verify_amount, 2), diff_verify_amount_val],
                    ['ä¼˜æƒ åæ ¸é”€é‡‘é¢ï¼š', round(p1_verify_discount, 2), round(p2_verify_discount, 2), diff_verify_discount_val],
                    ['å®¢å•ä»·ï¼š', p1_avg_price, p2_avg_price, diff_avg_price_val],
                    ['ç”µè¯ç‚¹å‡»ï¼š', p1_phone_clicks, p2_phone_clicks, diff_phone_val],
                    ['åœ°å€ç‚¹å‡»ï¼š', p1_address, p2_address, diff_address_val],
                    ['åœ¨çº¿å’¨è¯¢ï¼š', p1_consult, p2_consult, diff_consult_val],
                    ['é—¨åº—å¹²é¢„æ•°æ®', '', '', ''],
                    ['æ–°å¢å¥½è¯„ï¼š', p1_good_reviews, p2_good_reviews, diff_good_reviews_val],
                    ['ç•™è¯„ç‡ï¼š', p1_review_rate_val, p2_review_rate_val, diff_review_rate_val],
                    ['é—¨åº—æ”¶è—ï¼š', p1_collect, p2_collect, diff_collect_val],
                    ['æ”¶è—ç‡ï¼š', p1_collect_rate_val, p2_collect_rate_val, diff_collect_rate_val],
                    ['æ‰“å¡äººæ•°ï¼š', p1_checkin, p2_checkin, diff_checkin_val],
                    ['æ¨å¹¿é€šæ•°æ®', '', '', ''],
                    ['æ¨å¹¿é€šè®¢å•é‡', p1_promo_orders, p2_promo_orders, diff_promo_orders_val],
                    ['æ¨å¹¿é€šèŠ±è´¹', round(p1_promo_cost, 2), round(p2_promo_cost, 2), diff_promo_cost_val],
                    ['æ¨å¹¿é€šæ›å…‰ï¼ˆæ¬¡ï¼‰', p1_promo_exposure, p2_promo_exposure, diff_promo_exposure_val],
                    ['æ¨å¹¿é€šç‚¹å‡»ï¼ˆæ¬¡ï¼‰', p1_promo_clicks, p2_promo_clicks, diff_promo_clicks_val],
                    ['æ¨å¹¿é€šç‚¹å‡»å‡ä»·ï¼ˆå…ƒï¼‰', p1_click_price, p2_click_price, diff_click_price_val],
                    ['æŸ¥çœ‹å›¢è´­ï¼ˆæ¬¡ï¼‰', p1_view_groupbuy, p2_view_groupbuy, diff_view_groupbuy_val],
                    ['æŸ¥çœ‹ç”µè¯ï¼ˆæ¬¡ï¼‰', p1_view_phone, p2_view_phone, diff_view_phone_val],
                ]

                for row_data in detail_data:
                    ws_detail.append(row_data)

                # åˆå¹¶é—¨åº—åå•å…ƒæ ¼ A1:D1
                ws_detail.merge_cells('A1:D1')

                # åˆå¹¶ç¬¬18è¡Œå’Œç¬¬24è¡Œçš„A:Då•å…ƒæ ¼
                ws_detail.merge_cells('A18:D18')
                ws_detail.merge_cells('A24:D24')

                # è®¾ç½®è¯¦ç»†Sheetæ ·å¼ - åˆ—å®½: A=25, B=36, C=36, D=20
                ws_detail.column_dimensions['A'].width = 25
                ws_detail.column_dimensions['B'].width = 36
                ws_detail.column_dimensions['C'].width = 36
                ws_detail.column_dimensions['D'].width = 20

                # è®¾ç½®è¡Œé«˜ï¼šç¬¬1è¡Œ=31ï¼Œç¬¬2è¡Œåˆ°æœ€å=20
                ws_detail.row_dimensions[1].height = 31
                for row_num in range(2, len(detail_data) + 1):
                    ws_detail.row_dimensions[row_num].height = 20

                # å®šä¹‰é¢œè‰²
                header_fill = PatternFill(start_color="BDD7EE", end_color="BDD7EE", fill_type="solid")  # RGB(189,215,238)
                a_col_fill = PatternFill(start_color="DEEBF7", end_color="DEEBF7", fill_type="solid")  # RGB(222,235,247)

                # å®šä¹‰å­—ä½“ - å®‹ä½“ï¼ˆSimSunï¼‰
                title_font = Font(name='å®‹ä½“', size=16, color="000000")
                bcd_font = Font(name='å®‹ä½“', size=14, color="000000")

                # æ ‡é¢˜æ ·å¼ - é—¨åº—åå±…ä¸­åŠ ç²—ï¼Œå®‹ä½“16å·
                ws_detail['A1'].font = Font(name='å®‹ä½“', bold=True, size=16, color="000000")
                ws_detail['A1'].alignment = Alignment(horizontal='center', vertical='center')

                # ç¬¬2è¡Œï¼ˆæ ‡é¢˜è¡Œï¼‰æ ·å¼ - èƒŒæ™¯è‰²#BDD7EEï¼Œå®‹ä½“16å·é»‘è‰²
                for col in range(1, 5):
                    cell = ws_detail.cell(row=2, column=col)
                    cell.font = Font(name='å®‹ä½“', bold=True, size=16, color="000000")
                    cell.fill = header_fill
                    cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)

                # ç¬¬18è¡Œå’Œç¬¬24è¡Œæ ·å¼ - èƒŒæ™¯è‰²#BDD7EEï¼Œå®‹ä½“16å·é»‘è‰²
                for r in [18, 24]:
                    cell = ws_detail.cell(row=r, column=1)
                    cell.font = Font(name='å®‹ä½“', bold=True, size=16, color="000000")
                    cell.fill = header_fill
                    cell.alignment = Alignment(horizontal='center', vertical='center')

                # Aåˆ—å…¶ä»–è¡ŒèƒŒæ™¯è‰² #DEEBF7ï¼ŒB/C/Dåˆ—å­—ä½“å®‹ä½“14å·
                for row_num in range(3, len(detail_data) + 1):
                    if row_num not in [18, 24]:  # è·³è¿‡å·²å¤„ç†çš„åˆ†ç±»æ ‡é¢˜è¡Œ
                        # Aåˆ—èƒŒæ™¯è‰²
                        ws_detail.cell(row=row_num, column=1).fill = a_col_fill
                        ws_detail.cell(row=row_num, column=1).font = Font(name='å®‹ä½“', size=14, color="000000")
                        # B/C/Dåˆ—å­—ä½“
                        for col in range(2, 5):
                            ws_detail.cell(row=row_num, column=col).font = bcd_font

                # åº”ç”¨è¾¹æ¡†
                apply_border(ws_detail, 1, len(detail_data), 1, 4)

                # æ‰€æœ‰å•å…ƒæ ¼å±…ä¸­å¯¹é½
                for row_num in range(1, len(detail_data) + 1):
                    for col_num in range(1, 5):
                        ws_detail.cell(row=row_num, column=col_num).alignment = Alignment(horizontal='center', vertical='center')

                # è®¾ç½®å·®å€¼åˆ—é¢œè‰²ï¼ˆæ­£æ•°çº¢è‰²ï¼Œè´Ÿæ•°é»‘è‰²ï¼‰- ä¿æŒå®‹ä½“14å·
                for row_num in range(3, len(detail_data) + 1):
                    if row_num in [18, 24]:  # è·³è¿‡åˆ†ç±»æ ‡é¢˜è¡Œ
                        continue
                    cell = ws_detail.cell(row=row_num, column=4)
                    cell_value = cell.value
                    is_positive = False
                    if isinstance(cell_value, (int, float)):
                        is_positive = cell_value > 0
                    elif isinstance(cell_value, str) and '%' in cell_value:
                        try:
                            num_val = float(cell_value.replace('%', ''))
                            is_positive = num_val > 0
                        except:
                            pass
                    if is_positive:
                        cell.font = Font(name='å®‹ä½“', size=14, color="FF0000")

                seq_num += 1

            except Exception as e:
                # æ•è·é”™è¯¯å¹¶æ‰“å°è¯¦ç»†è°ƒè¯•ä¿¡æ¯
                print(f"\n{'âŒ' * 30}")
                print(f"âŒ å¤„ç†é—¨åº—æ—¶å‡ºé”™: {shop_name} (ID: {shop_id})")
                print(f"âŒ é”™è¯¯ç±»å‹: {type(e).__name__}")
                print(f"âŒ é”™è¯¯ä¿¡æ¯: {str(e)}")
                print(f"{'âŒ' * 30}")

                # æ‰“å°æ—¶æœŸ1æ•°æ®
                debug_print_row(shop_id, shop_name, p1, "æ—¶æœŸ1æ•°æ® (period1_data)")

                # æ‰“å°æ—¶æœŸ2æ•°æ®
                debug_print_row(shop_id, shop_name, p2, "æ—¶æœŸ2æ•°æ® (period2_data)")

                # æ‰“å°å®Œæ•´çš„å †æ ˆè·Ÿè¸ª
                print("\nğŸ“‹ å®Œæ•´é”™è¯¯å †æ ˆ:")
                traceback.print_exc()

                # è®°å½•å‡ºé”™çš„é—¨åº—
                error_shops.append({
                    'shop_id': shop_id,
                    'shop_name': shop_name,
                    'error': str(e),
                    'p1_data': p1,
                    'p2_data': p2
                })

                seq_num += 1
                continue

        # æ±‡æ€»è¡¨æ ·å¼ï¼ˆä¸å‘¨æŠ¥ä¿æŒä¸€è‡´ï¼Œ20åˆ—ï¼‰
        # è®¾ç½®åˆ—å®½ï¼šAåˆ—(åºå·)=8ï¼ŒBåˆ—(è¿è¥)=18ï¼ŒCåˆ—(åŸå¸‚)=10ï¼ŒDåˆ—(é”€å”®)=10ï¼ŒEåˆ—(é—¨åº—)=78ï¼ŒFåˆ—(æ•°æ®å‘¨æœŸ)=26ï¼Œå…¶ä»–åˆ—=15
        ws_summary.column_dimensions['A'].width = 8
        ws_summary.column_dimensions['B'].width = 18
        ws_summary.column_dimensions['C'].width = 10
        ws_summary.column_dimensions['D'].width = 10
        ws_summary.column_dimensions['E'].width = 78
        ws_summary.column_dimensions['F'].width = 26
        for i in range(7, 21):
            ws_summary.column_dimensions[get_column_letter(i)].width = 15

        thin_border = Border(
            left=Side(style='thin'),
            right=Side(style='thin'),
            top=Side(style='thin'),
            bottom=Side(style='thin')
        )

        # æµ…ç»¿è‰²èƒŒæ™¯ï¼ˆé—¨åº—è¡Œï¼‰#CCFFCC = RGB(204,255,204)
        green_fill = PatternFill(start_color="CCFFCC", end_color="CCFFCC", fill_type="solid")
        # çº¢è‰²å­—ä½“
        red_font = Font(color="FF0000")

        for row in ws_summary.iter_rows(min_row=1, max_row=ws_summary.max_row, min_col=1, max_col=20):
            for cell in row:
                cell.border = thin_border
                cell.alignment = Alignment(horizontal='center', vertical='center')

                # è¡¨å¤´è¡Œï¼ˆç¬¬1åˆ—ä¸º"åºå·"ï¼‰- æµ…ç»¿è‰²èƒŒæ™¯åŠ ç²—
                if cell.column == 1 and cell.value == 'åºå·':
                    for c in row:
                        c.font = Font(bold=True, size=10)
                        c.fill = green_fill
                elif cell.column == 6 and cell.value == 'æ•°æ®å‘¨æœŸ' and ws_summary.cell(row[0].row, 1).value == '':
                    for c in row:
                        c.font = Font(bold=True, size=10)
                        c.fill = green_fill

                # å·®å€¼è¡Œ - "å·®å€¼"æ–‡å­—çº¢è‰²ï¼Œæ•°å€¼çº¢è‰²ï¼Œä¸è®¾ç°è‰²èƒŒæ™¯
                if cell.column == 6 and cell.value == 'å·®å€¼':
                    for c in row:
                        # å·®å€¼è¡Œæ‰€æœ‰æ•°å€¼éƒ½è®¾ä¸ºçº¢è‰²
                        if c.column == 6:  # "å·®å€¼"æ–‡å­—æœ¬èº«ä¹Ÿçº¢è‰²
                            c.font = red_font
                        elif c.column > 6:  # æ•°å€¼åˆ—çº¢è‰²
                            c.font = red_font

        # åˆå¹¶Aåˆ—å•å…ƒæ ¼ï¼šæ¯ä¸ªé—¨åº—8è¡Œï¼Œåˆå¹¶ç¬¬2-8è¡Œï¼ˆé—¨åº—åè¡Œåˆ°å·®å€¼è¡Œï¼‰
        # è§„åˆ™ï¼šç¬¬1è¡Œæ˜¯è¡¨å¤´ï¼Œç¬¬2è¡Œæ˜¯é—¨åº—åï¼Œç¬¬3-8è¡ŒAåˆ—ä¸ºç©ºéœ€è¦åˆå¹¶
        # å³åˆå¹¶ 2-8, 10-16, 18-24, 26-32 ...
        row_idx = 2  # ä»ç¬¬2è¡Œå¼€å§‹ï¼ˆç¬¬ä¸€ä¸ªé—¨åº—åè¡Œï¼‰
        while row_idx <= ws_summary.max_row:
            merge_end = row_idx + 6  # åˆå¹¶7è¡Œ (row_idx åˆ° row_idx+6)
            if merge_end <= ws_summary.max_row:
                # åˆå¹¶A-Eåˆ—ï¼ˆåºå·ã€è¿è¥ã€åŸå¸‚ã€é”€å”®ã€é—¨åº—ï¼‰
                for col in range(1, 6):  # åˆ—1-5
                    ws_summary.merge_cells(start_row=row_idx, start_column=col, end_row=merge_end, end_column=col)
            row_idx += 8  # è·³åˆ°ä¸‹ä¸€ä¸ªé—¨åº—å—

        # ä¿å­˜æ–‡ä»¶
        if not output_filename:
            shop_count = len(all_shop_ids_set)
            output_filename = f"è‡ªå®šä¹‰ {shop_count}å®¶é—¨åº—éé¤ {period2_start.replace('-', '')}~{period2_end.replace('-', '')} {datetime.now().strftime('%Y%m%d%H%M%S')}.xlsx"

        wb.save(output_filename)

        # æ‰“å°æ±‡æ€»ä¿¡æ¯
        if error_shops:
            print(f"\n{'=' * 60}")
            print(f"âš ï¸ è­¦å‘Š: æœ‰ {len(error_shops)} ä¸ªé—¨åº—å¤„ç†å¤±è´¥:")
            for err in error_shops:
                print(f"  - {err['shop_name']} (ID: {err['shop_id']}): {err['error']}")
            print(f"{'=' * 60}")

        print(f"âœ… è‡ªå®šä¹‰æŠ¥è¡¨ç”ŸæˆæˆåŠŸ: {output_filename}")
        return output_filename

    finally:
        cursor.close()
        conn.close()


# ==================== ä¸»ç¨‹åºç¤ºä¾‹ ====================
if __name__ == "__main__":
    print("=" * 60)
    print("æ±Ÿé‘«æ•°æ®æŠ¥è¡¨ç”Ÿæˆç³»ç»Ÿï¼ˆè°ƒè¯•ç‰ˆï¼‰")
    print("=" * 60)

    # ç¤ºä¾‹ï¼šç”Ÿæˆæ—¥æŠ¥
    print("\nã€ç¤ºä¾‹1ã€‘ç”Ÿæˆæ—¥æŠ¥")
    try:
        generate_daily_report(
            report_date='2025-12-18',
            accounts=["13718175572a", "19318574226a","13720016243a"]
        )
    except Exception as e:
        print(f"âŒ æ—¥æŠ¥ç”Ÿæˆå¤±è´¥: {e}")
        traceback.print_exc()

    # ç¤ºä¾‹ï¼šç”Ÿæˆå‘¨æŠ¥
    print("\nã€ç¤ºä¾‹2ã€‘ç”Ÿæˆå‘¨æŠ¥")
    try:
        generate_weekly_report(
            week1_start='2025-12-01',
            week1_end='2025-12-07',
            week2_start='2025-12-08',
            week2_end='2025-12-14'
        )
    except Exception as e:
        print(f"âŒ å‘¨æŠ¥ç”Ÿæˆå¤±è´¥: {e}")
        traceback.print_exc()

    # ç¤ºä¾‹ï¼šç”ŸæˆæœˆæŠ¥
    print("\nã€ç¤ºä¾‹3ã€‘ç”ŸæˆæœˆæŠ¥")
    try:
        generate_monthly_report(
            month1_start='2025-12-01',
            month1_end='2025-12-07',
            month2_start='2025-12-08',
            month2_end='2025-12-14'
        )
    except Exception as e:
        print(f"âŒ æœˆæŠ¥ç”Ÿæˆå¤±è´¥: {e}")
        traceback.print_exc()

    # ç¤ºä¾‹ï¼šç”Ÿæˆè‡ªå®šä¹‰æŠ¥è¡¨
    print("\nã€ç¤ºä¾‹4ã€‘ç”Ÿæˆè‡ªå®šä¹‰æŠ¥è¡¨")
    try:
        generate_custom_report(
            period1_start='2025-12-01',
            period1_end='2025-12-07',
            period2_start='2025-12-08',
            period2_end='2025-12-14',
            shop_ids=None  # Noneè¡¨ç¤ºæ‰€æœ‰é—¨åº—ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥ [shop_id1, shop_id2, ...]
        )
    except Exception as e:
        print(f"âŒ è‡ªå®šä¹‰æŠ¥è¡¨ç”Ÿæˆå¤±è´¥: {e}")
        traceback.print_exc()

    print("\n" + "=" * 60)
    print("æ‰€æœ‰æŠ¥è¡¨ç”Ÿæˆå®Œæˆï¼")
    print("=" * 60)
